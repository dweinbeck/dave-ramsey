---
phase: 01-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/envelopes/types.ts
  - src/lib/envelopes/firestore.ts
  - src/lib/envelopes/format.ts
  - src/lib/envelopes/__tests__/types.test.ts
autonomous: true

must_haves:
  truths:
    - "Envelope Zod schema validates title as non-empty string and weeklyBudgetCents as positive integer"
    - "Transaction Zod schema validates amountCents as positive integer, date as YYYY-MM-DD string, and envelopeId as non-empty string"
    - "Firestore collection helpers always scope queries by userId parameter"
    - "formatCents converts integer cents to dollar string (e.g., 1050 -> '$10.50')"
    - "No function accepts userId from client input -- all helpers require userId as a parameter (server-side derived)"
  artifacts:
    - path: "src/lib/envelopes/types.ts"
      provides: "Zod schemas and TypeScript types for envelopes and transactions"
      exports: ["envelopeSchema", "transactionSchema", "Envelope", "EnvelopeTransaction"]
      contains: "zod/v4"
    - path: "src/lib/envelopes/firestore.ts"
      provides: "Firestore collection helpers with per-user scoping"
      exports: ["envelopesCol", "transactionsCol"]
      contains: "userId"
    - path: "src/lib/envelopes/format.ts"
      provides: "Display formatting utilities for cents"
      exports: ["formatCents"]
    - path: "src/lib/envelopes/__tests__/types.test.ts"
      provides: "Validation tests for Zod schemas"
      contains: "describe"
  key_links:
    - from: "src/lib/envelopes/types.ts"
      to: "zod/v4"
      via: "import z"
      pattern: "from \"zod/v4\""
    - from: "src/lib/envelopes/firestore.ts"
      to: "src/lib/firebase.ts"
      via: "import db"
      pattern: "from \"@/lib/firebase\""
    - from: "src/lib/envelopes/firestore.ts"
      to: "src/lib/envelopes/types.ts"
      via: "type references in JSDoc"
      pattern: "userId"
---

<objective>
Create the type system, Firestore data access helpers, and formatting utilities that enforce per-user data isolation and integer-cents monetary values.

Purpose: Every API route and UI component in later phases depends on these foundational types, schemas, and helpers. Defining them now with validation ensures INFRA-04 (data isolation) and INFRA-05 (integer cents) are baked into the type system from day one.

Output: Zod-validated type definitions, Firestore collection helpers with userId scoping, cents formatting utility, and schema validation tests.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

# Existing type and Firestore patterns:
@src/lib/billing/types.ts
@src/lib/billing/firestore.ts
@src/lib/firebase.ts

# Existing test pattern:
@src/lib/billing/__tests__/types.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schemas, TypeScript types, and validation tests</name>
  <files>
    src/lib/envelopes/types.ts
    src/lib/envelopes/__tests__/types.test.ts
  </files>
  <action>
    Create `src/lib/envelopes/types.ts` modeled on `src/lib/billing/types.ts`.

    Use `import { z } from "zod/v4"` (NOT `"zod"` -- the repo uses the v4 subpath).

    Define these schemas and types:

    ```typescript
    // Envelope creation/update schema (what the client sends)
    export const envelopeSchema = z.object({
      title: z.string().min(1).max(100),
      weeklyBudgetCents: z.number().int().min(1),  // positive integer cents
    });
    export type EnvelopeInput = z.infer<typeof envelopeSchema>;

    // Firestore document shape (what's stored)
    export type Envelope = {
      id: string;
      userId: string;
      title: string;
      weeklyBudgetCents: number;
      sortOrder: number;
      rollover: boolean;          // true = carry surplus, false = reset each week
      createdAt: FirebaseFirestore.Timestamp;
      updatedAt: FirebaseFirestore.Timestamp;
    };

    // Transaction creation schema (what the client sends)
    export const transactionSchema = z.object({
      envelopeId: z.string().min(1),
      amountCents: z.number().int().min(1),         // positive integer cents
      date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, "Date must be YYYY-MM-DD"),
      merchant: z.string().max(200).optional(),
      description: z.string().max(500).optional(),
    });
    export type TransactionInput = z.infer<typeof transactionSchema>;

    // Firestore document shape (what's stored)
    export type EnvelopeTransaction = {
      id: string;
      userId: string;
      envelopeId: string;
      amountCents: number;
      date: string;               // YYYY-MM-DD (user-entered, no timezone issues)
      merchant?: string;
      description?: string;
      createdAt: FirebaseFirestore.Timestamp;
      updatedAt: FirebaseFirestore.Timestamp;
    };

    // Overage allocation (defined now for type completeness, used in Phase 4)
    export type OverageAllocation = {
      id: string;
      userId: string;
      sourceTransactionId: string;  // the transaction that caused the overage
      donorEnvelopeId: string;      // the envelope donating funds
      amountCents: number;          // how much was reallocated
      createdAt: FirebaseFirestore.Timestamp;
    };
    ```

    IMPORTANT: Do NOT include `userId` in any Zod input schema. userId is NEVER accepted from the client. It's always derived server-side from `verifyUser()`. The input schemas only validate what the client sends.

    Create `src/lib/envelopes/__tests__/types.test.ts` modeled on `src/lib/billing/__tests__/types.test.ts`. Test cases:

    **envelopeSchema:**
    - Accepts valid input: `{ title: "Groceries", weeklyBudgetCents: 5000 }`
    - Rejects empty title: `{ title: "", weeklyBudgetCents: 5000 }`
    - Rejects zero budget: `{ title: "Groceries", weeklyBudgetCents: 0 }`
    - Rejects negative budget: `{ title: "Groceries", weeklyBudgetCents: -100 }`
    - Rejects non-integer budget (floating point): `{ title: "Groceries", weeklyBudgetCents: 10.5 }`
    - Rejects missing title: `{ weeklyBudgetCents: 5000 }`
    - Accepts title at max length (100 chars)
    - Rejects title over max length (101 chars)

    **transactionSchema:**
    - Accepts valid input: `{ envelopeId: "abc123", amountCents: 1050, date: "2026-02-10" }`
    - Accepts valid input with optional fields: `{ envelopeId: "abc123", amountCents: 1050, date: "2026-02-10", merchant: "Costco", description: "Weekly groceries" }`
    - Rejects missing envelopeId: `{ amountCents: 1050, date: "2026-02-10" }`
    - Rejects zero amount: `{ envelopeId: "abc123", amountCents: 0, date: "2026-02-10" }`
    - Rejects non-integer amount: `{ envelopeId: "abc123", amountCents: 10.5, date: "2026-02-10" }`
    - Rejects invalid date format: `{ envelopeId: "abc123", amountCents: 1050, date: "02/10/2026" }`
    - Rejects invalid date format (no dashes): `{ envelopeId: "abc123", amountCents: 1050, date: "20260210" }`
    - Accepts date with valid YYYY-MM-DD format
  </action>
  <verify>
    - `npm test -- src/lib/envelopes/__tests__/types.test.ts` -- all tests pass
    - `npm run build` -- no TypeScript errors
    - `npm run lint` -- no Biome errors
    - Grep for `"zod/v4"` in types.ts (not `"zod"`)
    - Grep types.ts confirms no `userId` in any z.object schema
  </verify>
  <done>
    Zod schemas validate envelope and transaction input. TypeScript types define Firestore document shapes. All test cases pass. No userId accepted from client input.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Firestore collection helpers and formatCents utility</name>
  <files>
    src/lib/envelopes/firestore.ts
    src/lib/envelopes/format.ts
  </files>
  <action>
    Create `src/lib/envelopes/firestore.ts` modeled on `src/lib/billing/firestore.ts`.

    ```typescript
    import { db } from "@/lib/firebase";

    function requireDb() {
      if (!db) {
        throw new Error("Firestore not available.");
      }
      return db;
    }

    /**
     * Returns the envelopes collection reference.
     * All queries MUST filter by userId server-side.
     * userId is ALWAYS derived from verifyUser(), never from client input.
     */
    export function envelopesCol() {
      return requireDb().collection("envelopes");
    }

    /**
     * Returns envelopes for a specific user, ordered by sortOrder.
     */
    export function envelopesForUser(userId: string) {
      return envelopesCol()
        .where("userId", "==", userId)
        .orderBy("sortOrder", "asc");
    }

    /**
     * Returns the envelope_transactions collection reference.
     */
    export function transactionsCol() {
      return requireDb().collection("envelope_transactions");
    }

    /**
     * Returns transactions for a specific user within a date range.
     * weekStart and weekEnd are YYYY-MM-DD strings.
     */
    export function transactionsForUserInWeek(
      userId: string,
      weekStart: string,
      weekEnd: string,
    ) {
      return transactionsCol()
        .where("userId", "==", userId)
        .where("date", ">=", weekStart)
        .where("date", "<=", weekEnd);
    }

    /**
     * Returns the overage_allocations collection reference.
     */
    export function allocationsCol() {
      return requireDb().collection("envelope_allocations");
    }
    ```

    Key design decisions:
    - Collection references return the raw collection (for write operations like `.add()`)
    - Query helpers (`envelopesForUser`, `transactionsForUserInWeek`) return pre-filtered queries
    - Every user-scoped function takes `userId` as a parameter (always server-derived)
    - Use top-level collections with `userId` field (not sub-collections), matching the billing pattern

    Create `src/lib/envelopes/format.ts`:

    ```typescript
    /**
     * Formats integer cents as a dollar string.
     * Examples: 1050 -> "$10.50", 0 -> "$0.00", 500 -> "$5.00"
     *
     * This is the ONLY place dollars appear. All storage and computation uses cents.
     */
    export function formatCents(cents: number): string {
      return `$${(cents / 100).toFixed(2)}`;
    }
    ```

    This is intentionally simple. No Intl.NumberFormat complexity for v1 -- USD only, always two decimal places.
  </action>
  <verify>
    - `npm run build` -- no TypeScript errors (firebase-admin types resolve for Firestore references)
    - `npm run lint` -- no Biome errors
    - Grep `firestore.ts` for `userId` parameter in all user-scoped functions
    - Grep `firestore.ts` confirms import from `@/lib/firebase`
    - Grep `format.ts` confirms `formatCents` is exported
  </verify>
  <done>
    Firestore helpers enforce per-user data isolation via userId parameter. formatCents converts integer cents to display strings. Build and lint pass.
  </done>
</task>

</tasks>

<verification>
1. `npm test -- src/lib/envelopes/__tests__/types.test.ts` -- all schema validation tests pass
2. `npm run build` -- no TypeScript errors across all new files
3. `npm run lint` -- no Biome errors
4. types.ts uses `"zod/v4"` import path
5. types.ts has NO userId in Zod input schemas
6. firestore.ts scopes ALL user queries by userId parameter
7. format.ts exports formatCents with correct cent-to-dollar conversion
</verification>

<success_criteria>
- Zod schemas reject invalid input (empty titles, non-integer cents, bad date formats)
- Zod schemas accept valid input (proper title + budget, proper transaction fields)
- Firestore helpers always require userId parameter for user-scoped queries
- formatCents correctly formats cents as dollar strings
- All types are exported and importable by future phases
- Build, lint, and tests all pass with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
