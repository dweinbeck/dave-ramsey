---
phase: 02-envelope-management
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
repo: personal-brand
files_modified:
  - src/components/envelopes/StatusBadge.tsx
  - src/components/envelopes/EnvelopeCard.tsx
  - src/components/envelopes/CreateEnvelopeCard.tsx
  - src/components/envelopes/EnvelopeForm.tsx
  - src/components/envelopes/GreetingBanner.tsx
  - src/components/envelopes/SavingsBanner.tsx
  - src/components/envelopes/EnvelopeCardGrid.tsx
  - src/components/envelopes/EnvelopesHomePage.tsx
  - src/app/envelopes/page.tsx
autonomous: false

must_haves:
  truths:
    - "User sees a greeting banner with their first name and current weekday on the envelopes home page"
    - "User sees envelope cards in a responsive grid with title, weekly budget, remaining, and status badge"
    - "User can create a new envelope by clicking a '+' card and filling in title and budget"
    - "User can edit an envelope's title, weekly budget, and rollover setting"
    - "User can delete an envelope with a confirmation step"
    - "User can reorder envelopes with up/down arrow buttons"
    - "User sees an overall on-track indicator aggregated across all envelopes"
    - "User sees cumulative savings total prominently displayed"
    - "All mutations use optimistic updates via SWR mutate for instant feedback"
  artifacts:
    - path: "src/components/envelopes/StatusBadge.tsx"
      provides: "On Track / Watch / Over badge with color coding"
      contains: "StatusBadge"
    - path: "src/components/envelopes/EnvelopeCard.tsx"
      provides: "Individual envelope card with budget, remaining, status, edit/delete/reorder controls"
      contains: "EnvelopeCard"
    - path: "src/components/envelopes/EnvelopeForm.tsx"
      provides: "Shared form for create and edit with title + budget + rollover fields"
      contains: "EnvelopeForm"
    - path: "src/components/envelopes/GreetingBanner.tsx"
      provides: "Personalized greeting with on-track summary"
      contains: "GreetingBanner"
    - path: "src/components/envelopes/SavingsBanner.tsx"
      provides: "Cumulative savings display"
      contains: "SavingsBanner"
    - path: "src/components/envelopes/EnvelopesHomePage.tsx"
      provides: "Client component orchestrator: data fetching, state management, CRUD handlers"
      contains: "EnvelopesHomePage"
    - path: "src/app/envelopes/page.tsx"
      provides: "Server page that renders EnvelopesHomePage"
      contains: "EnvelopesHomePage"
  key_links:
    - from: "src/components/envelopes/EnvelopesHomePage.tsx"
      to: "src/lib/envelopes/hooks.ts"
      via: "useEnvelopes() hook for data fetching"
      pattern: "import.*useEnvelopes.*from.*hooks"
    - from: "src/components/envelopes/EnvelopesHomePage.tsx"
      to: "src/lib/envelopes/api.ts"
      via: "envelopeFetch() for CRUD mutations"
      pattern: "import.*envelopeFetch.*from.*api"
    - from: "src/components/envelopes/EnvelopeCard.tsx"
      to: "src/lib/envelopes/format.ts"
      via: "formatCents() for dollar display"
      pattern: "import.*formatCents.*from.*format"
    - from: "src/app/envelopes/page.tsx"
      to: "src/components/envelopes/EnvelopesHomePage.tsx"
      via: "renders client component"
      pattern: "import.*EnvelopesHomePage"
---

<objective>
Build the complete envelopes home page UI in the personal-brand repo: greeting banner, envelope card grid with CRUD controls, reorder buttons, savings banner, and the create/edit form. Replace the placeholder page with the live, data-driven interface.

Purpose: This plan delivers the user-facing experience for Phase 2 -- the primary interface users interact with to manage their weekly budget envelopes.

Output: 8 new component files, 1 updated page file. Complete working home page with all CRUD operations, reorder, and savings display.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-envelope-management/02-RESEARCH.md
@.planning/phases/02-envelope-management/02-02-SUMMARY.md

# Host repo UI patterns:
# Read these from /Users/dweinbeck/Documents/personal-brand/
@src/components/ui/Card.tsx
@src/components/ui/Button.tsx
@src/components/envelopes/EnvelopesNav.tsx
@src/app/envelopes/page.tsx
@src/app/envelopes/layout.tsx
@src/context/AuthContext.tsx
@src/app/globals.css

# Data layer (created in Plan 02):
@src/lib/envelopes/hooks.ts
@src/lib/envelopes/api.ts
@src/lib/envelopes/types.ts
@src/lib/envelopes/format.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create display components (StatusBadge, EnvelopeCard, CreateEnvelopeCard, SavingsBanner, GreetingBanner, EnvelopeForm, EnvelopeCardGrid)</name>
  <files>
    src/components/envelopes/StatusBadge.tsx
    src/components/envelopes/EnvelopeCard.tsx
    src/components/envelopes/CreateEnvelopeCard.tsx
    src/components/envelopes/EnvelopeForm.tsx
    src/components/envelopes/GreetingBanner.tsx
    src/components/envelopes/SavingsBanner.tsx
    src/components/envelopes/EnvelopeCardGrid.tsx
  </files>
  <action>
    All components are "use client" and use the site's design system (Card, Button, CSS custom properties).

    **StatusBadge.tsx:**
    - Props: `{ status: "On Track" | "Watch" | "Over" }`
    - Renders a small pill/badge with color-coded background:
      - "On Track": bg-sage/15 text-sage (green tones)
      - "Watch": bg-amber/15 text-amber (warning tones)
      - "Over": bg-red-100 text-red-700 (danger tones)
    - Use `clsx` for conditional classes
    - Use CSS custom property colors where available: sage (#6b8e6f), amber (#d4956c)

    **EnvelopeCard.tsx:**
    - Props: `{ envelope: EnvelopeWithStatus, isFirst: boolean, isLast: boolean, onEdit: () => void, onDelete: () => void, onMoveUp: () => void, onMoveDown: () => void }`
    - Uses the site's `Card` component with `variant="default"`
    - Layout:
      - Top row: title (h3, font-display, font-bold, text-primary) + StatusBadge
      - Middle: remaining amount (text-2xl font-bold) + "of {budget}" (text-sm text-secondary)
      - Bottom row: action buttons (Edit, Delete as ghost Button, up/down arrow buttons for reorder)
      - Up arrow hidden when isFirst, down arrow hidden when isLast
    - Import `formatCents` from `@/lib/envelopes/format`
    - Reorder buttons: simple up/down arrow Unicode characters (↑ ↓) or Chevron icons via text

    **CreateEnvelopeCard.tsx:**
    - Props: `{ onClick: () => void }`
    - Uses Card component with `variant="default"` and dashed border style
    - Displays a "+" icon and "Add Envelope" text
    - Centered content, subtle hover effect
    - `cursor-pointer` on the card

    **EnvelopeForm.tsx:**
    - Props: `{ mode: "create" | "edit", initialValues?: { title: string, weeklyBudgetCents: number, rollover: boolean }, onSubmit: (data: { title: string, weeklyBudgetCents: number, rollover?: boolean }) => void, onCancel: () => void, isSubmitting: boolean }`
    - Renders a form with:
      - Title input (text, required, max 100 chars)
      - Weekly Budget input (number, in dollars for display -- convert to/from cents internally. User types "50.00", form stores 5000 cents)
      - Rollover toggle (checkbox, only shown in edit mode)
      - Submit button (Button variant="primary", text "Create" or "Save")
      - Cancel button (Button variant="ghost")
    - Client-side validation before submit (title not empty, budget > 0)
    - The form renders inline (not in a modal) -- it replaces the CreateEnvelopeCard when creating, or appears overlaid on the EnvelopeCard when editing

    **GreetingBanner.tsx:**
    - Props: `{ onTrackCount: number, totalCount: number }`
    - Uses `useAuth()` to get user name
    - Name extraction: `user.displayName?.split(" ")[0] || user.email?.split("@")[0] || "there"`
    - Weekday: `new Intl.DateTimeFormat("en-US", { weekday: "long" }).format(new Date())`
    - Renders: "Hi {name}! Today is {weekday}." with on-track summary below
    - Overall on-track indicator: "{onTrackCount} of {totalCount} envelopes on track this week."
    - Styled with rounded container, bg-primary/5, border-primary/10 (matches research example)

    **SavingsBanner.tsx:**
    - Props: `{ savingsCents: number }`
    - Displays cumulative savings using formatCents()
    - Prominent display: "Total Saved: {amount}" or similar
    - Only renders if savingsCents > 0
    - Subtle styling: smaller than greeting banner, perhaps a secondary callout

    **EnvelopeCardGrid.tsx:**
    - Props: `{ children: ReactNode }`
    - Responsive grid layout: 1 column on mobile, 2 on md, 3 on lg
    - CSS grid with gap: `grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4`
    - Simple wrapper component
  </action>
  <verify>
    ```bash
    cd /Users/dweinbeck/Documents/personal-brand && npx tsc --noEmit
    ```
    TypeScript compilation succeeds with no errors for all new component files.
  </verify>
  <done>
    7 component files created in src/components/envelopes/. All use the site's design system (Card, Button, clsx). StatusBadge shows color-coded status. EnvelopeCard displays budget info with action buttons. CreateEnvelopeCard shows "+" prompt. EnvelopeForm handles create/edit with dollar-to-cents conversion. GreetingBanner shows personalized greeting with on-track count. SavingsBanner shows cumulative savings. EnvelopeCardGrid provides responsive layout.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EnvelopesHomePage orchestrator and update page.tsx</name>
  <files>
    src/components/envelopes/EnvelopesHomePage.tsx
    src/app/envelopes/page.tsx
  </files>
  <action>
    **EnvelopesHomePage.tsx** -- The main client component that orchestrates everything:

    ```
    "use client";
    ```

    This component:
    1. Uses `useEnvelopes()` hook to fetch data
    2. Manages local UI state: `editingId`, `isCreating`, `isSubmitting`
    3. Implements CRUD handlers that call envelopeFetch() and then mutate() for optimistic updates

    **State management:**
    - `editingId: string | null` -- which envelope is in edit mode
    - `isCreating: boolean` -- whether the create form is showing
    - `isSubmitting: boolean` -- prevents double-submit
    - `deletingId: string | null` -- which envelope has delete confirmation showing

    **CRUD handlers (all use useAuth() for token):**

    `handleCreate(formData)`:
    - POST /api/envelopes with envelopeFetch
    - On success: mutate() to refresh SWR cache, set isCreating = false
    - On error: show error (simple window.alert for now -- modal coming in Phase 4)

    `handleUpdate(envelopeId, formData)`:
    - PUT /api/envelopes/{envelopeId} with envelopeFetch
    - On success: mutate(), set editingId = null
    - On error: show error

    `handleDelete(envelopeId)`:
    - DELETE /api/envelopes/{envelopeId} with envelopeFetch
    - On success: mutate(), set deletingId = null
    - On error: show error

    `handleReorder(envelopeId, direction: "up" | "down")`:
    - Compute new order by swapping the envelope with its neighbor
    - Optimistic update: mutate with reordered data
    - PUT /api/envelopes/reorder with the new orderedIds
    - On error: mutate() to revert

    **Render structure:**
    ```tsx
    <div className="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 py-8">
      {isLoading && <LoadingState />}
      {error && <ErrorState />}
      {data && (
        <>
          <GreetingBanner
            onTrackCount={data.envelopes.filter(e => e.status === "On Track").length}
            totalCount={data.envelopes.length}
          />
          {data.cumulativeSavingsCents > 0 && (
            <SavingsBanner savingsCents={data.cumulativeSavingsCents} />
          )}
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-display font-semibold text-primary">
              Week of {data.weekLabel}
            </h2>
          </div>
          <EnvelopeCardGrid>
            {data.envelopes.map((env, i) => (
              editingId === env.id ? (
                <Card variant="default" key={env.id}>
                  <EnvelopeForm
                    mode="edit"
                    initialValues={{ title: env.title, weeklyBudgetCents: env.weeklyBudgetCents, rollover: env.rollover }}
                    onSubmit={(formData) => handleUpdate(env.id, formData)}
                    onCancel={() => setEditingId(null)}
                    isSubmitting={isSubmitting}
                  />
                </Card>
              ) : (
                <EnvelopeCard
                  key={env.id}
                  envelope={env}
                  isFirst={i === 0}
                  isLast={i === data.envelopes.length - 1}
                  onEdit={() => setEditingId(env.id)}
                  onDelete={() => /* show confirmation or call handleDelete */}
                  onMoveUp={() => handleReorder(env.id, "up")}
                  onMoveDown={() => handleReorder(env.id, "down")}
                />
              )
            ))}
            {isCreating ? (
              <Card variant="default">
                <EnvelopeForm
                  mode="create"
                  onSubmit={handleCreate}
                  onCancel={() => setIsCreating(false)}
                  isSubmitting={isSubmitting}
                />
              </Card>
            ) : (
              <CreateEnvelopeCard onClick={() => setIsCreating(true)} />
            )}
          </EnvelopeCardGrid>
        </>
      )}
    </div>
    ```

    **Delete confirmation:** Simple inline confirmation. When deletingId is set, the EnvelopeCard shows "Are you sure?" with Confirm/Cancel buttons instead of the normal content. This avoids needing a modal (Modal component is built in Phase 4).

    **Loading state:** Simple centered spinner or "Loading your envelopes..." text
    **Error state:** "Something went wrong. Please try again." with a retry button that calls mutate()
    **Empty state:** When data.envelopes.length === 0 and not isCreating, show a friendly empty state message ("No envelopes yet. Create your first one!") along with the CreateEnvelopeCard.

    **src/app/envelopes/page.tsx** -- Replace the placeholder:
    ```tsx
    import { EnvelopesHomePage } from "@/components/envelopes/EnvelopesHomePage";

    export const metadata = {
      title: "Digital Envelopes",
    };

    export default function EnvelopesPage() {
      return <EnvelopesHomePage />;
    }
    ```

    IMPORTANT: page.tsx remains a server component (no "use client"). EnvelopesHomePage is the client component boundary. This follows Next.js App Router best practices.
  </action>
  <verify>
    ```bash
    cd /Users/dweinbeck/Documents/personal-brand && npm run build
    ```
    Build succeeds. The envelopes page renders without errors.
  </verify>
  <done>
    EnvelopesHomePage.tsx is a client component that orchestrates all CRUD operations with optimistic SWR updates. page.tsx is a server component that renders EnvelopesHomePage. The home page shows greeting banner, savings banner, envelope cards with edit/delete/reorder, and create card. Loading, error, and empty states are handled.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete envelopes home page with:
    - Personalized greeting banner ("Hi {name}! Today is {weekday}...")
    - Envelope card grid with budget, remaining, and status badges
    - Create envelope form (title + budget)
    - Edit envelope form (title + budget + rollover toggle)
    - Delete with inline confirmation
    - Reorder with up/down arrows
    - Cumulative savings banner
    - Overall on-track indicator
    - Loading/error/empty states
  </what-built>
  <how-to-verify>
    1. Start the dev server: `cd /Users/dweinbeck/Documents/personal-brand && npm run dev`
    2. Open http://localhost:3000/envelopes (you must be logged in)
    3. Verify the greeting banner shows your name and today's day of the week
    4. Click the "+" card to create a new envelope -- enter "Groceries" with $100/week budget
    5. Verify the card appears with "$100.00" budget and "On Track" status
    6. Create a second envelope "Entertainment" with $50/week
    7. Use the arrow buttons to reorder -- move Entertainment above Groceries
    8. Click Edit on Groceries, change budget to $75, save
    9. Click Delete on Entertainment, confirm deletion
    10. Verify the card disappears
    11. Check that the page is responsive: resize browser to mobile width
    12. Verify no console errors in browser dev tools
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
```bash
# Full build check
cd /Users/dweinbeck/Documents/personal-brand && npm run build

# Lint check
cd /Users/dweinbeck/Documents/personal-brand && npm run lint

# Type check
cd /Users/dweinbeck/Documents/personal-brand && npx tsc --noEmit
```

All commands must pass with zero errors.
</verification>

<success_criteria>
1. Greeting banner shows "Hi {name}! Today is {weekday}." with name fallback chain
2. Envelope cards display title, weekly budget (formatted as dollars), remaining, and color-coded status badge
3. Create flow: click "+" card -> form appears -> submit -> new card appears in grid
4. Edit flow: click Edit -> form replaces card -> save -> card updates
5. Delete flow: click Delete -> inline confirmation -> confirm -> card removed
6. Reorder flow: click up/down arrows -> cards swap positions -> persists on refresh
7. Rollover toggle visible in edit mode
8. Cumulative savings banner shows when savings > 0
9. Overall on-track count in greeting banner
10. Responsive grid: 1 col mobile, 2 col tablet, 3 col desktop
11. Loading, error, and empty states all render correctly
12. Build, lint, and type check pass with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-envelope-management/02-03-SUMMARY.md`
</output>
