---
phase: 04-overage-reallocation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/envelopes/types.ts
  - src/lib/envelopes/firestore.ts
  - src/lib/envelopes/__tests__/firestore.test.ts
autonomous: true

must_haves:
  truths:
    - "validateAllocations returns valid when allocations exactly equal overage and each is within donor remaining"
    - "validateAllocations returns specific error messages when constraints are violated (exceeds donor, sum mismatch, empty allocations)"
    - "computeEnvelopeStatus accounts for received and donated allocation amounts in remaining balance"
  artifacts:
    - path: "src/lib/envelopes/types.ts"
      provides: "donorAllocationSchema, overageAllocationSchema, OverageAllocationInput type, AllocationValidationResult type"
      contains: "overageAllocationSchema"
    - path: "src/lib/envelopes/firestore.ts"
      provides: "validateAllocations pure function, extended computeEnvelopeStatus"
      exports: ["validateAllocations", "computeEnvelopeStatus"]
    - path: "src/lib/envelopes/__tests__/firestore.test.ts"
      provides: "Tests for validateAllocations and extended computeEnvelopeStatus"
      min_lines: 50
  key_links:
    - from: "src/lib/envelopes/firestore.ts"
      to: "src/lib/envelopes/types.ts"
      via: "import OverageAllocationInput"
      pattern: "import.*OverageAllocationInput.*from.*types"
---

<objective>
Add allocation validation schemas, a reusable pure validation function (`validateAllocations`), and extend the balance computation to account for overage allocations (received and donated).

Purpose: Establish the testable core logic for overage validation that runs on both client and server, and ensure envelope remaining balances correctly incorporate allocation flows. This is the foundation all other Phase 4 work depends on.

Output: Zod schemas for allocation input, a pure `validateAllocations` function with comprehensive tests, and extended `computeEnvelopeStatus` accepting allocation amounts.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-overage-reallocation/04-RESEARCH.md
@src/lib/envelopes/types.ts
@src/lib/envelopes/firestore.ts
@src/lib/envelopes/__tests__/firestore.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add allocation Zod schemas and validation types to types.ts</name>
  <files>src/lib/envelopes/types.ts</files>
  <action>
Add the following to `src/lib/envelopes/types.ts` after the existing `transactionUpdateSchema`:

1. `donorAllocationSchema` -- Zod object with:
   - `donorEnvelopeId`: `z.string().min(1)`
   - `amountCents`: `z.number().int().min(1)` (positive integer cents, must be at least 1)

2. `overageAllocationSchema` -- Zod object with:
   - `sourceTransactionId`: `z.string().min(1)`
   - `allocations`: `z.array(donorAllocationSchema).min(1)` (at least one allocation required)

3. `OverageAllocationInput` type alias: `z.infer<typeof overageAllocationSchema>`

4. `AllocationValidationResult` type:
   ```typescript
   export type AllocationValidationResult =
     | { valid: true }
     | { valid: false; errors: string[] };
   ```

Use `"zod/v4"` import path (repo convention, already imported at top of file).
  </action>
  <verify>Run `npx tsc --noEmit` to confirm types compile without errors.</verify>
  <done>Four new exports in types.ts: donorAllocationSchema, overageAllocationSchema, OverageAllocationInput, AllocationValidationResult. TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Add validateAllocations pure function and extend computeEnvelopeStatus (TDD)</name>
  <files>src/lib/envelopes/firestore.ts, src/lib/envelopes/__tests__/firestore.test.ts</files>
  <action>
**RED phase -- Write failing tests first:**

Add a new `describe("validateAllocations")` block in `__tests__/firestore.test.ts` with these test cases:

1. **Valid allocation -- exact match:**
   - overageAmountCents: 5000, allocations: [{donorEnvelopeId: "d1", amountCents: 3000}, {donorEnvelopeId: "d2", amountCents: 2000}], donorBalances: Map({"d1": 10000, "d2": 5000}) => `{ valid: true }`

2. **Invalid -- sum less than overage:**
   - overageAmountCents: 5000, allocations: [{donorEnvelopeId: "d1", amountCents: 2000}], donorBalances: Map({"d1": 10000}) => `{ valid: false, errors: ["Total allocated (2000) does not equal overage (5000)"] }`

3. **Invalid -- sum exceeds overage:**
   - overageAmountCents: 5000, allocations: [{donorEnvelopeId: "d1", amountCents: 6000}], donorBalances: Map({"d1": 10000}) => `{ valid: false, errors: [...] }`

4. **Invalid -- donor allocation exceeds donor remaining:**
   - overageAmountCents: 5000, allocations: [{donorEnvelopeId: "d1", amountCents: 5000}], donorBalances: Map({"d1": 3000}) => `{ valid: false, errors: ["Allocation for d1 (5000) exceeds remaining balance (3000)"] }`

5. **Invalid -- unknown donor envelope (not in donorBalances):**
   - overageAmountCents: 1000, allocations: [{donorEnvelopeId: "unknown", amountCents: 1000}], donorBalances: Map({}) => `{ valid: false, errors: ["Donor envelope unknown not found"] }`

6. **Invalid -- empty allocations array (should be caught by Zod, but defense in depth):**
   - overageAmountCents: 1000, allocations: [], donorBalances: Map({}) => `{ valid: false, errors: ["No allocations provided"] }`

7. **Multiple errors returned at once:**
   - Test that two different violations in one call produce two error messages.

Add a new `describe("computeEnvelopeStatus with allocations")` block:

8. **No allocations (backward compatible):**
   - weeklyBudgetCents: 10000, spentCents: 3000, receivedAllocationsCents: 0, donatedAllocationsCents: 0 => remainingCents: 7000, same status as before

9. **With received allocations:**
   - weeklyBudgetCents: 10000, spentCents: 12000, receivedAllocationsCents: 5000, donatedAllocationsCents: 0 => remainingCents: 3000 (10000 - 12000 + 5000), status: "On Track" or "Watch" depending on day

10. **With donated allocations:**
    - weeklyBudgetCents: 10000, spentCents: 3000, receivedAllocationsCents: 0, donatedAllocationsCents: 4000 => remainingCents: 3000 (10000 - 3000 - 4000)

11. **Both received and donated:**
    - weeklyBudgetCents: 10000, spentCents: 5000, receivedAllocationsCents: 2000, donatedAllocationsCents: 3000 => remainingCents: 4000 (10000 - 5000 + 2000 - 3000)

Run tests -- they must ALL FAIL (no implementation yet).

**GREEN phase -- Implement to pass:**

1. Add `validateAllocations` to `firestore.ts` in the "Pure computation helpers" section:

```typescript
export function validateAllocations(
  allocations: { donorEnvelopeId: string; amountCents: number }[],
  overageAmountCents: number,
  donorBalances: Map<string, number>,
): AllocationValidationResult {
  const errors: string[] = [];

  if (allocations.length === 0) {
    return { valid: false, errors: ["No allocations provided"] };
  }

  for (const alloc of allocations) {
    const balance = donorBalances.get(alloc.donorEnvelopeId);
    if (balance === undefined) {
      errors.push(`Donor envelope ${alloc.donorEnvelopeId} not found`);
    } else if (alloc.amountCents > balance) {
      errors.push(
        `Allocation for ${alloc.donorEnvelopeId} (${alloc.amountCents}) exceeds remaining balance (${balance})`
      );
    }
  }

  const totalAllocated = allocations.reduce((sum, a) => sum + a.amountCents, 0);
  if (totalAllocated !== overageAmountCents) {
    errors.push(
      `Total allocated (${totalAllocated}) does not equal overage (${overageAmountCents})`
    );
  }

  return errors.length > 0 ? { valid: false, errors } : { valid: true };
}
```

2. Extend `computeEnvelopeStatus` signature to accept optional allocation params:

```typescript
export function computeEnvelopeStatus(
  weeklyBudgetCents: number,
  spentCents: number,
  today: Date,
  receivedAllocationsCents = 0,
  donatedAllocationsCents = 0,
): { remainingCents: number; status: "On Track" | "Watch" | "Over" } {
  const remainingCents = weeklyBudgetCents - spentCents + receivedAllocationsCents - donatedAllocationsCents;
  // ... rest unchanged
}
```

The optional params with defaults of 0 ensure backward compatibility -- all existing callers continue to work unchanged.

Import `AllocationValidationResult` from `./types`.

Run tests -- they must ALL PASS.

**REFACTOR phase:** Only if obvious cleanup exists. Do not over-engineer.
  </action>
  <verify>Run `npm test` -- all existing tests still pass and all new tests pass. Run `npx tsc --noEmit` -- no type errors.</verify>
  <done>
- `validateAllocations` function exported from firestore.ts, handles all constraint checking with specific error messages
- `computeEnvelopeStatus` accepts optional `receivedAllocationsCents` and `donatedAllocationsCents` params (defaults to 0 for backward compatibility)
- All new tests pass, all existing tests still pass
- TypeScript compiles cleanly
  </done>
</task>

</tasks>

<verification>
```bash
# All tests pass (existing + new)
npm test

# TypeScript compiles
npx tsc --noEmit

# New exports are available
grep -n "validateAllocations\|overageAllocationSchema\|donorAllocationSchema\|AllocationValidationResult" src/lib/envelopes/types.ts src/lib/envelopes/firestore.ts
```
</verification>

<success_criteria>
1. `donorAllocationSchema` and `overageAllocationSchema` Zod schemas exist in types.ts
2. `validateAllocations` returns `{ valid: true }` when constraints are met and `{ valid: false, errors: [...] }` when violated
3. `computeEnvelopeStatus` correctly computes `remainingCents = budget - spent + received - donated`
4. All tests pass (11+ new test cases), all existing tests still pass
5. TypeScript compiles with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-overage-reallocation/04-01-SUMMARY.md`
</output>
