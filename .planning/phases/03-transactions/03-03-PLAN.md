---
phase: 03-transactions
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - /Users/dweinbeck/Documents/personal-brand/src/app/envelopes/transactions/page.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionsPage.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionForm.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionList.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionRow.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/WeekSelector.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/InlineTransactionForm.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopeCard.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopesHomePage.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopeCardGrid.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a transaction from the Transactions page with Date, Cost, Envelope dropdown, Merchant, Description"
    - "User can edit a transaction's fields inline on the Transactions page"
    - "User can delete a transaction from the Transactions page with immediate UI update"
    - "User can navigate weeks on the Transactions page with prev/next buttons showing 'Week N: M/D/YYYY - M/D/YYYY'"
    - "User can expand an envelope card on the Home page to reveal an inline transaction form"
    - "Envelope remaining balance updates after any transaction mutation (create, edit, delete)"
  artifacts:
    - path: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionsPage.tsx"
      provides: "Client orchestrator for transactions page with week selection, CRUD, and state management"
      min_lines: 80
    - path: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/WeekSelector.tsx"
      provides: "Week navigation with prev/next and formatted label"
      min_lines: 20
    - path: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionForm.tsx"
      provides: "Full transaction form with Envelope dropdown for Transactions page"
      min_lines: 60
    - path: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionList.tsx"
      provides: "Table/list of transactions for selected week"
      min_lines: 20
    - path: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionRow.tsx"
      provides: "Single transaction row with edit/delete actions and inline edit form"
      min_lines: 40
    - path: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/InlineTransactionForm.tsx"
      provides: "Compact inline form for home page card expansion"
      min_lines: 50
  key_links:
    - from: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionsPage.tsx"
      to: "/api/envelopes/transactions"
      via: "useTransactions hook + envelopeFetch for mutations"
      pattern: "useTransactions|envelopeFetch.*transactions"
    - from: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopesHomePage.tsx"
      to: "/api/envelopes/transactions"
      via: "envelopeFetch POST for inline transaction creation"
      pattern: "envelopeFetch.*api/envelopes/transactions.*POST"
    - from: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionsPage.tsx"
      to: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/WeekSelector.tsx"
      via: "weekStart state drives WeekSelector display and useTransactions fetch"
      pattern: "WeekSelector.*onWeekChange"
---

<objective>
Build the complete Transactions page UI (week selector, transaction form, transaction list with edit/delete) and the inline transaction form that expands from envelope cards on the Home page.

Purpose: Delivers the user-facing transaction management experience from both entry points (dedicated Transactions page and Home page inline form), completing Phase 3's core value.
Output: 6 new components, 2 modified components, 1 modified page
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-transactions/03-RESEARCH.md
@.planning/phases/03-transactions/03-02-SUMMARY.md

Key existing components to reference/modify:
- /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopesHomePage.tsx -- Add inline transaction handler + expandedId state
- /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopeCard.tsx -- Add "Add Transaction" button + expand toggle
- /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopeCardGrid.tsx -- No change needed (col-span-full applied on grid items)
- /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopeForm.tsx -- Reference for form patterns (dollar-to-cents, controlled state)
- /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts -- useTransactions + useEnvelopes hooks
- /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/api.ts -- envelopeFetch helper
- /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/week-math.ts -- getWeekRange, getWeekNumber, formatWeekLabel
- /Users/dweinbeck/Documents/personal-brand/src/components/ui/Button.tsx -- Button component (primary, secondary, ghost variants)
- /Users/dweinbeck/Documents/personal-brand/src/components/ui/Card.tsx -- Card component

Design decisions:
- [Research]: Inline form restricted to current week dates (min=Sunday, max=Saturday)
- [Research]: "Add Transaction" button toggles form at top of Transactions page (not always visible)
- [Research]: Edit mode replaces row with inline form (same as envelope editing pattern)
- [Research]: CSS col-span-full on grid item for expanded card (not on card itself)
- [02-03]: window.alert for error display (temporary, modal coming in Phase 4)
- [02-03]: Native button elements for a11y
- [Research]: No optimistic updates for transaction edits -- invalidate and refetch
</context>

<tasks>

<task type="auto">
  <name>Task 1: Transactions page components (WeekSelector, TransactionForm, TransactionList, TransactionRow, TransactionsPage)</name>
  <files>
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/WeekSelector.tsx
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionForm.tsx
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionList.tsx
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionRow.tsx
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionsPage.tsx
    /Users/dweinbeck/Documents/personal-brand/src/app/envelopes/transactions/page.tsx
  </files>
  <action>
    Create 5 new components and update the transactions page.

    **1. WeekSelector.tsx** -- `"use client"` component:
    Props: `{ weekStart: Date; onWeekChange: (newWeekStart: Date) => void }`
    - Import `addWeeks`, `subWeeks`, `format` from date-fns and `getWeekNumber`, `getWeekRange` from `@/lib/envelopes/week-math`
    - Compute weekNum via `getWeekNumber(weekStart)`, get range via `getWeekRange(weekStart)` for display
    - Display: `Week {weekNum}: {format(range.start, "M/d/yyyy")} - {format(range.end, "M/d/yyyy")}`
    - Left arrow button calls `onWeekChange(subWeeks(weekStart, 1))`, right arrow calls `onWeekChange(addWeeks(weekStart, 1))`
    - Use `Button` component with `variant="ghost" size="sm"`, add `aria-label="Previous week"` / `"Next week"`
    - Center the label with `min-w-[260px] text-center`
    - Style: `flex items-center gap-2`

    **2. TransactionForm.tsx** -- `"use client"` component:
    Props: `{ envelopes: { id: string; title: string }[]; onSubmit: (data: TransactionInput) => void; onCancel: () => void; isSubmitting: boolean; initialValues?: { envelopeId: string; amountCents: number; date: string; merchant?: string; description?: string } }`
    - `mode` derived from `initialValues` presence (edit vs create)
    - Controlled state for: envelopeId (dropdown), costDollars (string), date, merchant, description
    - Dollar-to-cents conversion on submit: `Math.round(Number.parseFloat(costDollars) * 100)`
    - Validation: cost > 0, envelopeId selected, date present
    - Fields layout: responsive grid -- `grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3`
    - Envelope dropdown: `<select>` with options from `envelopes` prop, placeholder "Select envelope..."
    - Date: `<input type="date">`
    - Cost: `<input type="number" step="0.01" min="0.01">`
    - Merchant: `<input type="text" maxLength={200}>`
    - Description: `<input type="text" maxLength={500}>`
    - Submit + Cancel buttons at bottom
    - If `initialValues`, pre-populate all fields (convert amountCents to dollars for display: `(initialValues.amountCents / 100).toFixed(2)`)
    - Use same input styling as existing EnvelopeForm: `rounded-lg border border-border bg-surface px-3 py-2 text-sm text-text-primary focus:outline-2 focus:outline-offset-2 focus:outline-gold`

    **3. TransactionRow.tsx** -- `"use client"` component:
    Props: `{ transaction: EnvelopeTransaction; envelopes: { id: string; title: string }[]; onUpdate: (transactionId: string, data: TransactionUpdateInput) => void; onDelete: (transactionId: string) => void; isSubmitting: boolean }`
    - Default mode: display row showing Date, Amount (formatCents), Envelope title (look up from envelopes array), Merchant, Description, with Edit and Delete action buttons
    - Edit mode: `editingId` state toggles to show TransactionForm pre-populated with transaction values, passing `onSubmit` that calls `onUpdate(transaction.id, data)`, `onCancel` resets editingId
    - Delete: calls `onDelete(transaction.id)` directly (no confirmation for transactions -- they're easily re-created, unlike envelope deletion which cascades)
    - Responsive: on mobile, stack fields vertically; on desktop, horizontal row

    **4. TransactionList.tsx** -- `"use client"` component:
    Props: `{ transactions: EnvelopeTransaction[]; envelopes: { id: string; title: string }[]; onUpdate: (transactionId: string, data: TransactionUpdateInput) => void; onDelete: (transactionId: string) => void; isSubmitting: boolean }`
    - If transactions is empty, show "No transactions this week." message
    - Otherwise, render a list of TransactionRow components
    - Header row (desktop only): Date | Amount | Envelope | Merchant | Description | Actions
    - Use `divide-y divide-border` for row separation

    **5. TransactionsPage.tsx** -- `"use client"` client orchestrator:
    - State: `weekStart` (Date, initialized to `startOfWeek(new Date(), { weekStartsOn: 0 })`), `isCreating` (boolean), `isSubmitting` (boolean), `editingId` (string | null)
    - Compute `weekStartStr` and `weekEndStr` from weekStart via `getWeekRange` + `format(..., "yyyy-MM-dd")`
    - Use `useTransactions(weekStartStr, weekEndStr)` for transaction data
    - Use `useEnvelopes()` for envelope list (needed for dropdown + display)
    - `getToken` helper (same pattern as EnvelopesHomePage)
    - Handlers:
      - `handleCreate(data: TransactionInput)`: POST to `/api/envelopes/transactions`, on success mutate both transactions and envelopes SWR caches, set isCreating=false
      - `handleUpdate(transactionId: string, data)`: PUT to `/api/envelopes/transactions/${transactionId}`, on success mutate both caches
      - `handleDelete(transactionId: string)`: DELETE to `/api/envelopes/transactions/${transactionId}`, on success mutate both caches
      - `handleWeekChange(newWeekStart: Date)`: set weekStart state
    - Error handling: `window.alert(err.message)` (temporary, Phase 4 modal)
    - Layout:
      ```
      <WeekSelector weekStart={weekStart} onWeekChange={handleWeekChange} />
      {isCreating ? (
        <TransactionForm envelopes={...} onSubmit={handleCreate} onCancel={...} isSubmitting={...} />
      ) : (
        <Button onClick={() => setIsCreating(true)}>Add Transaction</Button>
      )}
      <TransactionList transactions={...} envelopes={...} onUpdate={handleUpdate} onDelete={handleDelete} isSubmitting={isSubmitting} />
      ```
    - Pass `envelopes` as `data.envelopes.map(e => ({ id: e.id, title: e.title }))` to TransactionForm and TransactionList
    - Loading and error states follow EnvelopesHomePage pattern

    **6. Update transactions/page.tsx:**
    Replace the placeholder with:
    ```tsx
    import { TransactionsPage } from "@/components/envelopes/TransactionsPage";

    export const metadata = {
      title: "Transactions | Digital Envelopes",
    };

    export default function TransactionsRoute() {
      return <TransactionsPage />;
    }
    ```

    **IMPORTANT patterns to follow:**
    - All components use `"use client"` directive
    - All `envelopeFetch` calls include method + JSON body (POST/PUT) or just method (DELETE)
    - After mutations, ALWAYS call both `mutateTransactions()` AND `mutateEnvelopes()` to refresh balances
    - Use `envelopeFetch` from `@/lib/envelopes/api` for all API calls
    - Use Button component from `@/components/ui/Button` (not raw button elements for primary actions)
    - Use Card component for form containers where appropriate
    - Input styling: match existing `EnvelopeForm` input classes
  </action>
  <verify>
    ```bash
    cd /Users/dweinbeck/Documents/personal-brand && npm run build
    ```
    Build succeeds. All new components compile without TypeScript errors.
  </verify>
  <done>
    - Transactions page shows WeekSelector with "Week N: M/D/YYYY - M/D/YYYY" and prev/next navigation
    - "Add Transaction" button toggles TransactionForm with Envelope dropdown, Date, Cost, Merchant, Description
    - Transaction list shows all transactions for selected week with edit and delete actions
    - Edit replaces row with pre-populated form
    - Week navigation changes the displayed transactions
    - All mutations refresh both transaction and envelope SWR caches
  </done>
</task>

<task type="auto">
  <name>Task 2: Inline transaction form on Home page (card expansion)</name>
  <files>
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/InlineTransactionForm.tsx
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopeCard.tsx
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopesHomePage.tsx
  </files>
  <action>
    Add inline transaction creation to envelope cards on the Home page.

    **1. InlineTransactionForm.tsx** -- `"use client"` component:
    Props: `{ envelopeId: string; defaultDate: string; minDate: string; maxDate: string; onSubmit: (data: { envelopeId: string; amountCents: number; date: string; merchant?: string; description?: string }) => void; onCancel: () => void; isSubmitting: boolean }`
    - Compact 4-field form: Date, Cost ($), Merchant, Description -- NO envelope dropdown (implicit from card context)
    - Date restricted to current week: `min={minDate}` and `max={maxDate}` on `<input type="date">`
    - Dollar-to-cents conversion on submit (same pattern as TransactionForm)
    - Validation: cost > 0
    - Layout: `grid grid-cols-2 gap-3 sm:grid-cols-4` for fields
    - Submit ("Add") + Cancel buttons below fields
    - Error display: `<p role="alert">` for client-side validation errors
    - Border-top separator: `pt-3 border-t border-border`
    - Follow the exact code from research section "Inline Transaction Form Component"

    **2. Modify EnvelopeCard.tsx:**
    Add a new prop: `onAddTransaction: () => void`
    - In the bottom action row (alongside Edit, Delete), add an "Add Txn" button:
      ```tsx
      <Button variant="ghost" size="sm" onClick={onAddTransaction}>
        + Txn
      </Button>
      ```
    - Place it in the left button group, after "Delete" button
    - This button is only shown in non-deleting state (the normal card view)

    **3. Modify EnvelopesHomePage.tsx:**
    Add `expandedId` state (string | null, default null) for tracking which envelope has the inline form open.

    Add `handleInlineTransaction` async handler:
    ```typescript
    async function handleInlineTransaction(data: {
      envelopeId: string;
      amountCents: number;
      date: string;
      merchant?: string;
      description?: string;
    }) {
      setIsSubmitting(true);
      try {
        const token = await getToken();
        await envelopeFetch("/api/envelopes/transactions", token, {
          method: "POST",
          body: JSON.stringify(data),
        });
        await mutate(); // Refresh envelope balances
        setExpandedId(null); // Collapse the form
      } catch (err) {
        window.alert(
          err instanceof Error ? err.message : "Failed to add transaction.",
        );
      } finally {
        setIsSubmitting(false);
      }
    }
    ```

    Modify the envelope card rendering loop. Currently each card is rendered directly as a child of `<EnvelopeCardGrid>`. Wrap each card (both the edit form and the normal card) in a `<div>` that gets `className="col-span-full"` when expanded. Import `clsx` for conditional class.

    Updated rendering pattern (replace the current `envelopes.map(...)` block):
    ```tsx
    {envelopes.map((env: EnvelopeWithStatus, i: number) => (
      <div
        key={env.id}
        className={clsx(expandedId === env.id && "col-span-full")}
      >
        {editingId === env.id ? (
          <Card variant="default">
            <EnvelopeForm
              mode="edit"
              initialValues={{
                title: env.title,
                weeklyBudgetCents: env.weeklyBudgetCents,
                rollover: env.rollover,
              }}
              onSubmit={(formData) => handleUpdate(env.id, formData)}
              onCancel={() => setEditingId(null)}
              isSubmitting={isSubmitting}
            />
          </Card>
        ) : (
          <EnvelopeCard
            envelope={env}
            isFirst={i === 0}
            isLast={i === envelopes.length - 1}
            isDeleting={deletingId === env.id}
            onEdit={() => setEditingId(env.id)}
            onDelete={() => setDeletingId(env.id)}
            onConfirmDelete={() => handleDelete(env.id)}
            onCancelDelete={() => setDeletingId(null)}
            onMoveUp={() => handleReorder(env.id, "up")}
            onMoveDown={() => handleReorder(env.id, "down")}
            onAddTransaction={() => setExpandedId(
              expandedId === env.id ? null : env.id
            )}
          />
        )}
        {expandedId === env.id && editingId !== env.id && (
          <InlineTransactionForm
            envelopeId={env.id}
            defaultDate={format(new Date(), "yyyy-MM-dd")}
            minDate={currentWeekStart}
            maxDate={currentWeekEnd}
            onSubmit={handleInlineTransaction}
            onCancel={() => setExpandedId(null)}
            isSubmitting={isSubmitting}
          />
        )}
      </div>
    ))}
    ```

    Compute `currentWeekStart` and `currentWeekEnd` for the inline form date constraints:
    ```typescript
    import { format, startOfWeek, endOfWeek } from "date-fns";
    // Near the top of the component:
    const now = new Date();
    const currentWeekStart = format(startOfWeek(now, { weekStartsOn: 0 }), "yyyy-MM-dd");
    const currentWeekEnd = format(endOfWeek(now, { weekStartsOn: 0 }), "yyyy-MM-dd");
    ```

    Import InlineTransactionForm and clsx at the top. Also import `format`, `startOfWeek`, `endOfWeek` from date-fns.

    **Interaction rules:**
    - Expanding a card closes any open edit form (set `editingId = null`)
    - Opening edit form closes any expanded card (set `expandedId = null`)
    - Only one expanded/editing card at a time
    - When `onAddTransaction` is called, also set `editingId(null)` and `deletingId(null)`
    - When `onEdit` is called, also set `expandedId(null)`
  </action>
  <verify>
    ```bash
    cd /Users/dweinbeck/Documents/personal-brand && npm run build && npm run lint
    ```
    Build and lint pass. No TypeScript errors, no Biome warnings.
  </verify>
  <done>
    - EnvelopeCard has "+ Txn" button that triggers expansion
    - Clicking "+ Txn" expands the card to full grid width with an inline form below
    - Inline form has Date (restricted to current week), Cost, Merchant, Description fields
    - Submitting the inline form creates a transaction and refreshes envelope balances
    - Form collapses after successful submission
    - Expanding a card closes any open edit/delete state
    - Only one card can be expanded at a time
  </done>
</task>

</tasks>

<verification>
```bash
# Full build + lint check
cd /Users/dweinbeck/Documents/personal-brand && npm run build && npm run lint

# Verify all new files exist
ls -la /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/WeekSelector.tsx
ls -la /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionForm.tsx
ls -la /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionList.tsx
ls -la /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionRow.tsx
ls -la /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionsPage.tsx
ls -la /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/InlineTransactionForm.tsx
```
- Build succeeds with zero errors
- Lint passes with zero warnings/errors
- All 6 new component files exist
- EnvelopeCard.tsx and EnvelopesHomePage.tsx modified
</verification>

<success_criteria>
- Transactions page has a working WeekSelector showing "Week N: M/D/YYYY - M/D/YYYY"
- "Add Transaction" button toggles a form with Envelope dropdown + Date + Cost + Merchant + Description
- Transaction list shows all transactions for the selected week
- Users can edit transactions inline (row transforms to form)
- Users can delete transactions with immediate list update
- Envelope cards on Home page have "+ Txn" button that expands to inline form
- Inline form restricts dates to current week
- All mutations refresh both transaction list and envelope balance caches
</success_criteria>

<output>
After completion, create `.planning/phases/03-transactions/03-03-SUMMARY.md`
</output>
