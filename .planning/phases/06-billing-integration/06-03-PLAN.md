---
phase: 06-billing-integration
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/ReadOnlyBanner.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopesHomePage.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionsPage.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/AnalyticsPage.tsx
autonomous: true

must_haves:
  truths:
    - "When billing mode is readonly, a prominent banner says 'Read-Only Mode' and links to /billing to buy credits"
    - "When billing mode is readonly, the Create Envelope button, edit/delete envelope controls, inline transaction form, and transaction form are all disabled or hidden"
    - "When billing mode is readwrite, no banner shows and all controls work normally (no regression)"
    - "ReadOnlyBanner appears on all 3 envelope pages (home, transactions, analytics) when readonly"
  artifacts:
    - path: "src/components/envelopes/ReadOnlyBanner.tsx"
      provides: "Read-only mode visual indicator with Buy Credits link"
      exports: ["ReadOnlyBanner"]
    - path: "src/components/envelopes/EnvelopesHomePage.tsx"
      provides: "Home page with billing-aware mutation controls"
      contains: "isReadOnly"
    - path: "src/components/envelopes/TransactionsPage.tsx"
      provides: "Transactions page with billing-aware mutation controls"
      contains: "isReadOnly"
    - path: "src/components/envelopes/AnalyticsPage.tsx"
      provides: "Analytics page with ReadOnlyBanner when readonly"
      contains: "ReadOnlyBanner"
  key_links:
    - from: "src/components/envelopes/EnvelopesHomePage.tsx"
      to: "API response"
      via: "data?.billing?.mode from useEnvelopes()"
      pattern: "billing.*readonly"
    - from: "src/components/envelopes/ReadOnlyBanner.tsx"
      to: "/billing"
      via: "href link"
      pattern: "/billing"
---

<objective>
Implement client-side read-only mode with visual indicators on all envelope pages. When a user's billing access is readonly, disable all mutation controls (create, edit, delete, reorder) and show a ReadOnlyBanner explaining the situation with a link to purchase credits.

Purpose: The server-side gates (Plan 06-02) enforce billing. This plan provides the UX so users understand why they cannot edit and how to resolve it.
Output: ReadOnlyBanner component + billing-aware EnvelopesHomePage, TransactionsPage, AnalyticsPage.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-billing-integration/06-RESEARCH.md
@.planning/phases/06-billing-integration/06-01-SUMMARY.md
@.planning/phases/06-billing-integration/06-02-SUMMARY.md

# Source files:
@/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopesHomePage.tsx
@/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionsPage.tsx
@/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/AnalyticsPage.tsx
@/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/types.ts
@/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts
@/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/GreetingBanner.tsx
@/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/SavingsBanner.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ReadOnlyBanner component</name>
  <files>
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/ReadOnlyBanner.tsx
  </files>
  <action>
Create a new `ReadOnlyBanner.tsx` component in the envelopes components directory. Follow the existing pattern of GreetingBanner.tsx and SavingsBanner.tsx for styling approach.

```typescript
"use client";

export function ReadOnlyBanner() {
  return (
    <div className="mb-6 rounded-xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-800">
      <p className="font-semibold">Read-Only Mode</p>
      <p className="mt-1">
        Your free week has ended. Purchase credits to continue adding and editing
        envelopes and transactions.
      </p>
      <a
        href="/billing"
        className="mt-2 inline-block font-medium text-amber-900 underline hover:no-underline"
      >
        Buy Credits
      </a>
    </div>
  );
}
```

Design notes:
- Uses amber color scheme (warning, not error) to convey informational urgency without alarm
- Matches the existing banner component pattern (GreetingBanner, SavingsBanner) with mb-6 for spacing
- Links to /billing which is the existing billing/credits page in the site
- "use client" directive since it's rendered inside client components
- Keep it simple -- no props needed. The parent decides whether to render it.
  </action>
  <verify>
Run `cd /Users/dweinbeck/Documents/personal-brand && npx tsc --noEmit` to verify the component compiles.
  </verify>
  <done>
ReadOnlyBanner component exists at src/components/envelopes/ReadOnlyBanner.tsx with clear messaging and link to /billing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire billing status into all envelope page components</name>
  <files>
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopesHomePage.tsx
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionsPage.tsx
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/AnalyticsPage.tsx
  </files>
  <action>
Read each component file FULLY before making changes. The billing status comes from the API response (added in Plan 06-02) via the existing SWR hooks. No hook changes needed -- the types were already updated in Plan 06-01 to include `billing: BillingStatus` in HomePageData, TransactionsPageData, and AnalyticsPageData.

**EnvelopesHomePage.tsx changes:**

1. Add import: `import { ReadOnlyBanner } from "./ReadOnlyBanner";`

2. Derive `isReadOnly` from the SWR data:
```typescript
const isReadOnly = data?.billing?.mode === "readonly";
```
Place this right after the `useEnvelopes()` call and existing state declarations.

3. Render ReadOnlyBanner conditionally, right before the GreetingBanner (or as the first content after loading/error states):
```typescript
{isReadOnly && <ReadOnlyBanner />}
```

4. Disable mutation controls when isReadOnly:
   - **CreateEnvelopeCard**: Do not render when isReadOnly. Wrap in `{!isReadOnly && <CreateEnvelopeCard ... />}`
   - **Edit button** on EnvelopeCard: Pass `isReadOnly` prop or conditionally hide. Since EnvelopeCard is imported, the simplest approach is to not render edit/delete buttons when isReadOnly. Check how the current code handles this:
     - If there is an `onEdit` callback prop, pass `undefined` when isReadOnly
     - If there is a separate edit button, conditionally hide it
   - **Delete button**: Same approach -- pass undefined or hide
   - **Inline transaction form (expandedId)**: Prevent expansion when isReadOnly. If there is an `onExpand` or toggle function, guard it: `if (isReadOnly) return;`
   - **Reorder controls**: If drag-and-drop or reorder buttons exist, disable when isReadOnly

   The exact implementation depends on how the current component passes callbacks. Read the full component. The safest approach: add `isReadOnly` checks at the top of each handler function:
   ```typescript
   const handleDelete = useCallback(async (id: string) => {
     if (isReadOnly) return; // <-- add this
     // ... existing logic
   }, [isReadOnly, ...]);
   ```

   And for UI visibility:
   - Wrap `<CreateEnvelopeCard>` in `{!isReadOnly && ...}`
   - Add `disabled` or don't render edit/delete buttons

5. For the expand-to-add-transaction behavior: guard the expand toggle:
```typescript
const handleExpand = (id: string) => {
  if (isReadOnly) return;
  setExpandedId(expandedId === id ? null : id);
};
```

**TransactionsPage.tsx changes:**

1. Add import: `import { ReadOnlyBanner } from "./ReadOnlyBanner";`

2. The transactions data comes from `useTransactions()` which returns `TransactionsPageData` -- this now includes `billing`. However, need to check: the existing `useTransactions()` hook returns `{ data, error, isLoading, mutate }` where `data` is `TransactionsPageData`. But the billing status should be consistent across hooks. Since useTransactions fetches from the transactions endpoint, its response now includes billing.

   But there's an issue: `useTransactions` might NOT have billing from its specific endpoint yet. Wait -- Plan 06-02 adds billing to the transactions GET response. So `txData?.billing` will exist. But the page ALSO uses `useEnvelopes()` for the envelope dropdown. Either hook's response provides billing status (they use the same checkEnvelopeAccess).

   Use: `const isReadOnly = txData?.billing?.mode === "readonly";`

3. Render `{isReadOnly && <ReadOnlyBanner />}` before the main content.

4. Disable the "Add Transaction" button / TransactionForm when isReadOnly:
   - Guard the isCreating state: `{!isReadOnly && <Button onClick={() => setIsCreating(true)}>Add Transaction</Button>}`
   - Or hide the entire TransactionForm when isReadOnly
   - Disable edit/delete on TransactionList items -- check how TransactionList receives callbacks. If via props, pass `undefined` when isReadOnly.

**AnalyticsPage.tsx changes:**

1. Add import: `import { ReadOnlyBanner } from "./ReadOnlyBanner";`

2. The analytics page uses `useAnalytics()` which returns `AnalyticsPageData`. This now includes billing from Plan 06-02.

   `const isReadOnly = data?.billing?.mode === "readonly";`

3. Render `{isReadOnly && <ReadOnlyBanner />}` before the main analytics content.

4. Analytics is read-only by nature (no mutation controls), so no buttons to disable. The banner is the only addition.

**CRITICAL: Do NOT break existing functionality.** All changes are additive (new component, new conditional checks). When isReadOnly is false or billing is undefined (loading state), all existing behavior remains unchanged. Use optional chaining (`data?.billing?.mode`) to safely handle the undefined case during loading.
  </action>
  <verify>
1. Run `cd /Users/dweinbeck/Documents/personal-brand && npx tsc --noEmit` to verify all components compile.
2. Run `cd /Users/dweinbeck/Documents/personal-brand && npm run lint` to verify Biome linting passes.
3. Run `cd /Users/dweinbeck/Documents/personal-brand && npm run build` to verify the build succeeds.
4. Grep for ReadOnlyBanner usage: `grep -r "ReadOnlyBanner" src/components/envelopes/ --include="*.tsx" -l` should return 4 files (the component + 3 pages).
5. Grep for isReadOnly: `grep -r "isReadOnly" src/components/envelopes/ --include="*.tsx" -l` should return 3 page files.
  </verify>
  <done>
- ReadOnlyBanner renders on all 3 pages when billing mode is readonly
- EnvelopesHomePage: CreateEnvelopeCard hidden, edit/delete disabled, inline form expansion blocked
- TransactionsPage: Add Transaction button hidden, edit/delete on rows disabled
- AnalyticsPage: ReadOnlyBanner shown (no mutations to disable)
- All controls work normally when billing mode is readwrite (no regression)
- TypeScript compiles, lint passes, build succeeds
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/dweinbeck/Documents/personal-brand && npx tsc --noEmit` passes
2. `cd /Users/dweinbeck/Documents/personal-brand && npm run lint` passes
3. `cd /Users/dweinbeck/Documents/personal-brand && npm run build` passes
4. `grep -r "ReadOnlyBanner" src/components/envelopes/ --include="*.tsx" -l` returns 4 files
5. `grep -r "isReadOnly" src/components/envelopes/ --include="*.tsx" -l` returns at least 2 files (home + transactions)
6. No console.log or debugger statements in new/modified files
</verification>

<success_criteria>
- ReadOnlyBanner component exists and renders on all 3 envelope pages when billing mode is readonly
- When readonly: no create, edit, delete, or reorder operations available in the UI
- When readwrite: no visual changes, all existing functionality works normally
- TypeScript compiles, lint passes, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-billing-integration/06-03-SUMMARY.md`
</output>
