---
phase: 02-envelope-management
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
repo: personal-brand
files_modified:
  - src/lib/envelopes/types.ts
  - src/lib/envelopes/firestore.ts
  - src/lib/envelopes/hooks.ts
  - src/app/api/envelopes/route.ts
  - src/app/api/envelopes/[envelopeId]/route.ts
  - src/app/api/envelopes/reorder/route.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/envelopes returns enriched envelope list with remaining balances, status labels, week label, and cumulative savings for the authenticated user"
    - "POST /api/envelopes creates a new envelope with Zod-validated input and returns 201 with the created envelope"
    - "PUT /api/envelopes/[envelopeId] updates an envelope's title, weeklyBudgetCents, or rollover with ownership verification"
    - "DELETE /api/envelopes/[envelopeId] deletes an envelope with cascading cleanup of related transactions and allocations"
    - "PUT /api/envelopes/reorder updates sortOrder for all provided envelope IDs atomically"
    - "All API routes reject unauthenticated requests with 401"
    - "useEnvelopes() SWR hook fetches authenticated envelope data and exposes mutate for optimistic updates"
  artifacts:
    - path: "src/lib/envelopes/types.ts"
      provides: "Zod schemas and TypeScript types for envelopes (copied from dave-ramsey repo)"
      contains: "envelopeSchema"
    - path: "src/lib/envelopes/firestore.ts"
      provides: "Server-side Firestore CRUD operations for envelopes"
      exports: ["createEnvelope", "updateEnvelope", "deleteEnvelope", "reorderEnvelopes", "listEnvelopesWithRemaining"]
    - path: "src/lib/envelopes/hooks.ts"
      provides: "SWR hook for client-side data fetching"
      exports: ["useEnvelopes"]
    - path: "src/app/api/envelopes/route.ts"
      provides: "GET and POST handlers for envelope list and creation"
      exports: ["GET", "POST"]
    - path: "src/app/api/envelopes/[envelopeId]/route.ts"
      provides: "PUT and DELETE handlers for individual envelope operations"
      exports: ["PUT", "DELETE"]
    - path: "src/app/api/envelopes/reorder/route.ts"
      provides: "PUT handler for batch reorder"
      exports: ["PUT"]
  key_links:
    - from: "src/app/api/envelopes/route.ts"
      to: "src/lib/envelopes/firestore.ts"
      via: "imports CRUD functions for server-side operations"
      pattern: "import.*from.*@/lib/envelopes/firestore"
    - from: "src/app/api/envelopes/route.ts"
      to: "src/lib/auth/user.ts"
      via: "verifyUser() for authentication"
      pattern: "import.*verifyUser.*from.*@/lib/auth/user"
    - from: "src/lib/envelopes/hooks.ts"
      to: "/api/envelopes"
      via: "SWR fetch with Bearer token"
      pattern: "useSWR.*api/envelopes"
---

<objective>
Create the envelope API routes and client-side data layer in the personal-brand repo, bridging the Firestore CRUD operations to HTTP endpoints and providing an SWR hook for UI consumption.

Purpose: This plan establishes the server-side API and client-side data fetching layer that Plan 03 (UI components) will consume. It follows the exact patterns established by the billing API routes.

Output: 3 API route files, 1 Firestore operations module, 1 types module, 1 SWR hooks module.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-envelope-management/02-RESEARCH.md
@.planning/phases/02-envelope-management/02-01-SUMMARY.md

# Host repo patterns to follow:
# Read these files from /Users/dweinbeck/Documents/personal-brand/
@src/app/api/billing/me/route.ts
@src/lib/billing/firestore.ts
@src/lib/auth/user.ts
@src/context/AuthContext.tsx
@src/lib/brand-scraper/hooks.ts

# Source of truth for types and firestore helpers (dave-ramsey repo):
# Read these from /Users/dweinbeck/Documents/dave-ramsey/
@src/lib/envelopes/types.ts
@src/lib/envelopes/firestore.ts
@src/lib/envelopes/week-math.ts
@src/lib/envelopes/format.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create envelope types, firestore CRUD, and format utilities in personal-brand repo</name>
  <files>
    src/lib/envelopes/types.ts
    src/lib/envelopes/firestore.ts
    src/lib/envelopes/week-math.ts
    src/lib/envelopes/format.ts
  </files>
  <action>
    Create `src/lib/envelopes/` directory in the personal-brand repo with copies of the dave-ramsey shared utilities, adapted for the host repo's imports.

    **src/lib/envelopes/types.ts:**
    Copy from dave-ramsey repo's src/lib/envelopes/types.ts. This includes:
    - envelopeSchema (Zod v4)
    - transactionSchema (Zod v4)
    - Envelope, EnvelopeTransaction, OverageAllocation types
    - EnvelopeWithStatus and HomePageData types (added by Plan 02-01)
    - Add a new Zod schema for reorder input:
      ```typescript
      export const reorderSchema = z.object({
        orderedIds: z.array(z.string().min(1)).min(1),
      });
      ```
    - Add a partial update schema for PUT:
      ```typescript
      export const envelopeUpdateSchema = z.object({
        title: z.string().min(1).max(100).optional(),
        weeklyBudgetCents: z.number().int().min(1).optional(),
        rollover: z.boolean().optional(),
      });
      ```

    **src/lib/envelopes/week-math.ts:**
    Copy from dave-ramsey repo's src/lib/envelopes/week-math.ts exactly (getWeekRange, getRemainingDaysPercent, getStatusLabel, formatWeekLabel). date-fns is already installed in personal-brand repo.

    **src/lib/envelopes/format.ts:**
    Copy from dave-ramsey repo's src/lib/envelopes/format.ts exactly (formatCents).

    **src/lib/envelopes/firestore.ts:**
    Create adapted from dave-ramsey repo, but importing from `@/lib/firebase` (host repo's Firebase init, NOT a stub). Follow the billing/firestore.ts pattern exactly:

    ```typescript
    import { FieldValue } from "firebase-admin/firestore";
    import { db } from "@/lib/firebase";
    import { format, startOfWeek, endOfWeek } from "date-fns";
    import { getWeekRange, getRemainingDaysPercent, getStatusLabel, formatWeekLabel } from "./week-math";
    import type { Envelope, EnvelopeWithStatus, HomePageData } from "./types";
    ```

    Functions to implement (matching dave-ramsey repo's 02-01 output):
    - `requireDb()` (same pattern as billing)
    - `envelopesCol()`, `transactionsCol()`, `allocationsCol()` (collection refs)
    - `envelopesForUser(userId)`, `transactionsForUserInWeek(userId, weekStart, weekEnd)` (query helpers)
    - `createEnvelope(userId, input)` -> returns envelope with ID
    - `updateEnvelope(userId, envelopeId, input)` -> void, verifies ownership
    - `deleteEnvelope(userId, envelopeId)` -> void, cascading batched delete
    - `reorderEnvelopes(userId, orderedIds)` -> void, batched sortOrder update
    - `listEnvelopesWithRemaining(userId)` -> HomePageData
    - `computeCumulativeSavings(userId)` -> number (cents)

    IMPORTANT: Do NOT log request bodies or user-generated content (titles, descriptions). Only log error messages and operation metadata. Follow the billing route's error logging pattern: `console.error("GET /api/envelopes error:", error instanceof Error ? error.message : "Unknown");`
  </action>
  <verify>
    ```bash
    cd /Users/dweinbeck/Documents/personal-brand && npx tsc --noEmit src/lib/envelopes/types.ts src/lib/envelopes/firestore.ts src/lib/envelopes/week-math.ts src/lib/envelopes/format.ts
    ```
    TypeScript compilation succeeds with no errors.
  </verify>
  <done>
    src/lib/envelopes/ directory exists in personal-brand repo with types.ts, firestore.ts, week-math.ts, and format.ts. All files compile without TypeScript errors. Firestore functions match the patterns from billing/firestore.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create API routes for envelope CRUD and reorder</name>
  <files>
    src/app/api/envelopes/route.ts
    src/app/api/envelopes/[envelopeId]/route.ts
    src/app/api/envelopes/reorder/route.ts
  </files>
  <action>
    Create three API route files following the billing/me/route.ts pattern exactly.

    **src/app/api/envelopes/route.ts (GET + POST):**
    ```typescript
    import { unauthorizedResponse, verifyUser } from "@/lib/auth/user";
    import { envelopeSchema } from "@/lib/envelopes/types";
    import { createEnvelope, listEnvelopesWithRemaining } from "@/lib/envelopes/firestore";

    export async function GET(request: Request) {
      const auth = await verifyUser(request);
      if (!auth.authorized) return unauthorizedResponse(auth);
      try {
        const data = await listEnvelopesWithRemaining(auth.uid);
        return Response.json(data);
      } catch (error) {
        console.error("GET /api/envelopes error:", error instanceof Error ? error.message : "Unknown");
        return Response.json({ error: "Failed to load envelopes." }, { status: 500 });
      }
    }

    export async function POST(request: Request) {
      const auth = await verifyUser(request);
      if (!auth.authorized) return unauthorizedResponse(auth);
      try {
        const body = await request.json();
        const parsed = envelopeSchema.safeParse(body);
        if (!parsed.success) {
          return Response.json({ error: "Invalid input.", details: parsed.error.issues }, { status: 400 });
        }
        const envelope = await createEnvelope(auth.uid, parsed.data);
        return Response.json(envelope, { status: 201 });
      } catch (error) {
        console.error("POST /api/envelopes error:", error instanceof Error ? error.message : "Unknown");
        return Response.json({ error: "Failed to create envelope." }, { status: 500 });
      }
    }
    ```

    **src/app/api/envelopes/[envelopeId]/route.ts (PUT + DELETE):**
    - PUT: verifyUser -> parse body with envelopeUpdateSchema -> updateEnvelope(auth.uid, params.envelopeId, parsed.data) -> return 200
    - DELETE: verifyUser -> deleteEnvelope(auth.uid, params.envelopeId) -> return 200 { success: true }
    - Both catch errors and return 500 (or re-throw 404 from ownership check as 404)
    - For ownership errors ("Envelope not found or access denied."), return 404 instead of 500

    Next.js 16 App Router dynamic route params: The route handler receives `(request: Request, { params }: { params: Promise<{ envelopeId: string }> })`. Must await params: `const { envelopeId } = await params;`

    **src/app/api/envelopes/reorder/route.ts (PUT):**
    - PUT: verifyUser -> parse body with reorderSchema -> reorderEnvelopes(auth.uid, parsed.data.orderedIds) -> return 200 { success: true }
    - Catch and return 500 on error

    IMPORTANT privacy rules:
    - Never log request body content (titles, merchant names, descriptions)
    - Only log error.message, not the full error object
    - userId is always derived from verifyUser(), never from request body
  </action>
  <verify>
    ```bash
    cd /Users/dweinbeck/Documents/personal-brand && npx tsc --noEmit
    ```
    Full TypeScript build succeeds. API route files exist at the correct paths.
  </verify>
  <done>
    Three API route files created. GET /api/envelopes returns HomePageData. POST /api/envelopes creates envelope with 201. PUT /api/envelopes/[id] updates envelope fields. DELETE /api/envelopes/[id] cascading deletes. PUT /api/envelopes/reorder batch updates sortOrder. All routes use verifyUser() and return proper status codes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create SWR hook and client-side fetch helpers</name>
  <files>
    src/lib/envelopes/hooks.ts
    src/lib/envelopes/api.ts
  </files>
  <action>
    **src/lib/envelopes/api.ts** -- Client-side fetch helpers with Bearer token:
    ```typescript
    "use client";

    /**
     * Authenticated fetch helper for envelope API routes.
     * Includes Bearer token from Firebase Auth.
     */
    export async function envelopeFetch<T>(
      url: string,
      token: string,
      options?: RequestInit,
    ): Promise<T> {
      const res = await fetch(url, {
        ...options,
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
          ...options?.headers,
        },
      });
      if (!res.ok) {
        const body = await res.json().catch(() => ({ error: "Request failed" }));
        throw new Error(body.error || `Request failed: ${res.status}`);
      }
      return res.json() as Promise<T>;
    }
    ```

    **src/lib/envelopes/hooks.ts** -- SWR hook for envelope data:
    ```typescript
    "use client";

    import useSWR from "swr";
    import { useAuth } from "@/context/AuthContext";
    import type { HomePageData } from "@/lib/envelopes/types";
    import { envelopeFetch } from "./api";

    export function useEnvelopes() {
      const { user } = useAuth();

      const { data, error, isLoading, mutate } = useSWR<HomePageData>(
        user ? "/api/envelopes" : null,
        async (url: string) => {
          const token = await user!.getIdToken();
          return envelopeFetch<HomePageData>(url, token);
        },
      );

      return { data, error, isLoading, mutate };
    }
    ```

    The `mutate` function returned by useEnvelopes() allows Plan 03's UI components to perform optimistic updates after create/edit/delete/reorder operations.

    NOTE: Do not import server-side modules (firebase-admin, Firestore) in these client-side files. These files ONLY use the browser fetch API and the Firebase client SDK (via useAuth).
  </action>
  <verify>
    ```bash
    cd /Users/dweinbeck/Documents/personal-brand && npx tsc --noEmit src/lib/envelopes/hooks.ts src/lib/envelopes/api.ts
    ```
    TypeScript compilation succeeds. No server-side imports in client files.
  </verify>
  <done>
    hooks.ts exports useEnvelopes() SWR hook that returns { data, error, isLoading, mutate }. api.ts exports envelopeFetch() helper with Bearer token authentication. Both are "use client" modules with no server-side dependencies.
  </done>
</task>

</tasks>

<verification>
```bash
# Full TypeScript check
cd /Users/dweinbeck/Documents/personal-brand && npx tsc --noEmit

# Lint check
cd /Users/dweinbeck/Documents/personal-brand && npm run lint

# Build check
cd /Users/dweinbeck/Documents/personal-brand && npm run build
```

All three commands must pass with zero errors.
</verification>

<success_criteria>
1. GET /api/envelopes returns HomePageData shape (envelopes with status, weekLabel, cumulativeSavingsCents)
2. POST /api/envelopes validates input with envelopeSchema and returns 201
3. PUT /api/envelopes/[id] validates with envelopeUpdateSchema and updates specific fields
4. DELETE /api/envelopes/[id] cascading deletes with batched write
5. PUT /api/envelopes/reorder validates with reorderSchema and batch updates sortOrder
6. All routes return 401 for unauthenticated requests
7. useEnvelopes() SWR hook returns data, error, isLoading, mutate
8. No server-side imports in client files (hooks.ts, api.ts)
9. No request body content logged in error handlers
10. TypeScript, lint, and build all pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-envelope-management/02-02-SUMMARY.md`
</output>
