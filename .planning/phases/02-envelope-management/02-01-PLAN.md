---
phase: 02-envelope-management
plan: 01
type: tdd
wave: 1
depends_on: []
repo: dave-ramsey
files_modified:
  - src/lib/envelopes/types.ts
  - src/lib/envelopes/firestore.ts
  - src/lib/envelopes/__tests__/firestore.test.ts
autonomous: true

must_haves:
  truths:
    - "createEnvelope stores a new envelope with userId, title, weeklyBudgetCents, sortOrder, rollover=false, and timestamps"
    - "updateEnvelope modifies only provided fields (title, weeklyBudgetCents, rollover) and rejects unauthorized access"
    - "deleteEnvelope removes the envelope and all related transactions and allocations atomically"
    - "reorderEnvelopes writes sequential sortOrder values for all provided envelope IDs"
    - "listEnvelopesWithRemaining returns envelopes enriched with spentCents, remainingCents, and status for the current week"
    - "computeCumulativeSavings returns the total unspent budget from completed past weeks for non-rollover envelopes only"
  artifacts:
    - path: "src/lib/envelopes/types.ts"
      provides: "EnvelopeWithStatus and HomePageData types"
      contains: "EnvelopeWithStatus"
    - path: "src/lib/envelopes/firestore.ts"
      provides: "CRUD operations and savings computation"
      exports: ["createEnvelope", "updateEnvelope", "deleteEnvelope", "reorderEnvelopes", "listEnvelopesWithRemaining", "computeCumulativeSavings"]
    - path: "src/lib/envelopes/__tests__/firestore.test.ts"
      provides: "Tests for all CRUD operations and savings computation"
      min_lines: 80
  key_links:
    - from: "src/lib/envelopes/firestore.ts"
      to: "src/lib/envelopes/types.ts"
      via: "imports Envelope, EnvelopeWithStatus, HomePageData types"
      pattern: "import.*from.*types"
    - from: "src/lib/envelopes/firestore.ts"
      to: "src/lib/envelopes/week-math.ts"
      via: "imports getWeekRange, getRemainingDaysPercent, getStatusLabel for balance computation"
      pattern: "import.*from.*week-math"
---

<objective>
Add envelope CRUD operations, balance computation, and cumulative savings calculation to the dave-ramsey shared utilities repo using TDD.

Purpose: These functions are the canonical, tested implementations of all envelope data operations. Phase 2 Plans 02 and 03 (in the personal-brand repo) will replicate these patterns for runtime use.

Output: Extended types.ts with EnvelopeWithStatus/HomePageData types, extended firestore.ts with 6 CRUD/query functions, comprehensive test suite.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@.planning/phases/02-envelope-management/02-RESEARCH.md

@src/lib/envelopes/types.ts
@src/lib/envelopes/firestore.ts
@src/lib/envelopes/week-math.ts
@src/lib/envelopes/format.ts
</context>

<feature>
  <name>Envelope CRUD Operations and Savings Computation</name>
  <files>
    src/lib/envelopes/types.ts
    src/lib/envelopes/firestore.ts
    src/lib/envelopes/__tests__/firestore.test.ts
  </files>
  <behavior>
    ## New Types (types.ts)

    Add these types AFTER the existing types:

    ```typescript
    /** Envelope enriched with computed fields for display. */
    export type EnvelopeWithStatus = Envelope & {
      spentCents: number;
      remainingCents: number;
      status: "On Track" | "Watch" | "Over";
    };

    /** Response shape for GET /api/envelopes (home page data). */
    export type HomePageData = {
      envelopes: EnvelopeWithStatus[];
      weekLabel: string;
      cumulativeSavingsCents: number;
    };
    ```

    ## CRUD Functions (firestore.ts)

    Add these functions to the existing firestore.ts file. Import FieldValue from firebase-admin/firestore. Import getWeekRange, getRemainingDaysPercent, getStatusLabel from week-math.ts. Import formatWeekLabel from week-math.ts. Import startOfWeek, endOfWeek, format from date-fns.

    ### createEnvelope(userId, input) -> Envelope
    - input: { title: string, weeklyBudgetCents: number }
    - Query existing envelopes for user to find max sortOrder
    - Create doc with: userId, title, weeklyBudgetCents, sortOrder: maxSort + 1, rollover: false, createdAt: serverTimestamp, updatedAt: serverTimestamp
    - Return the created envelope with its generated ID

    ### updateEnvelope(userId, envelopeId, input) -> void
    - input: Partial<{ title: string, weeklyBudgetCents: number, rollover: boolean }>
    - Verify ownership: get doc, check userId matches
    - If not found or wrong user, throw "Envelope not found or access denied."
    - Update only provided fields + updatedAt: serverTimestamp

    ### deleteEnvelope(userId, envelopeId) -> void
    - Verify ownership (same as update)
    - Find all transactions where userId + envelopeId match
    - Find all allocations where donorEnvelopeId matches
    - Find all allocations where sourceTransactionId matches any of the transaction IDs
    - Batched write: delete envelope + all related transactions + all related allocations
    - If total operations > 450, split into multiple batches (Firestore limit is 500)

    ### reorderEnvelopes(userId, orderedIds) -> void
    - Batched write: for each ID at index i, update sortOrder: i, updatedAt: serverTimestamp
    - No ownership verification per-doc needed (batch is within user context from API layer)

    ### listEnvelopesWithRemaining(userId) -> HomePageData
    - Get current week range from getWeekRange(new Date())
    - Parallel fetch: envelopesForUser(userId).get() and transactionsForUserInWeek(userId, weekStart, weekEnd).get()
    - For each envelope: sum transactions, compute remainingCents = weeklyBudgetCents - spentCents
    - For rollover envelopes: remainingCents = weeklyBudgetCents + carryover - spentCents (carryover computation deferred, just use weeklyBudgetCents for now -- rollover carry-forward is a Phase 2 stretch goal noted in research open questions)
    - Compute status via getStatusLabel(remainingCents, weeklyBudgetCents, getRemainingDaysPercent(today))
    - Compute cumulativeSavingsCents via computeCumulativeSavings(userId)
    - Return { envelopes: sorted enriched list, weekLabel: formatWeekLabel(today), cumulativeSavingsCents }

    ### computeCumulativeSavings(userId) -> number
    - Get all envelopes for user
    - If none, return 0
    - Find earliest createdAt across all envelopes
    - Get current week start
    - Query all transactions between earliestWeekStart and currentWeekStart (completed weeks only)
    - Iterate week by week from earliest to current:
      - For each non-rollover envelope that existed in that week:
        - Sum transactions for that envelope in that week
        - unspent = max(0, weeklyBudgetCents - spent)
        - Add unspent to totalSavingsCents
    - Return totalSavingsCents

    ## Test Cases

    Mock Firestore using a simple in-memory mock (or test the logic functions with extracted pure functions). The key behaviors to test:

    1. createEnvelope: assigns sortOrder 0 for first envelope, sortOrder N for Nth
    2. updateEnvelope: throws for wrong userId, updates only provided fields
    3. deleteEnvelope: throws for wrong userId, deletes envelope + related docs
    4. reorderEnvelopes: assigns sequential sortOrder 0, 1, 2...
    5. listEnvelopesWithRemaining: correctly computes remaining and status
    6. computeCumulativeSavings: returns 0 for no envelopes, sums only non-rollover, ignores current week, floors at 0 per envelope

    NOTE: Since these functions depend on Firestore, create a mock for the Firestore admin SDK. The simplest approach: extract the pure computation logic into testable helper functions, and test those. The Firestore integration will be tested via API route tests in the personal-brand repo.

    Specifically, extract and test:
    - `computeEnvelopeStatus(weeklyBudgetCents, spentCents, today)` -> { remainingCents, status }
    - `computeSavingsForWeek(envelopes, transactions, weekStart, weekEnd)` -> savingsCents
    - `computeCumulativeSavingsFromData(envelopes, transactions, earliestDate, currentWeekStart)` -> totalSavingsCents
  </behavior>
  <implementation>
    1. RED: Write failing tests for the pure computation helpers first (computeEnvelopeStatus, computeSavingsForWeek, computeCumulativeSavingsFromData), then for the Firestore-dependent functions using mocks.
    2. GREEN: Add EnvelopeWithStatus and HomePageData types to types.ts. Implement all functions in firestore.ts. Make tests pass.
    3. REFACTOR: Clean up if needed. Ensure all exports are properly named.

    Key imports for firestore.ts:
    ```typescript
    import { FieldValue } from "firebase-admin/firestore";
    import { format, startOfWeek, endOfWeek } from "date-fns";
    import { getWeekRange, getRemainingDaysPercent, getStatusLabel, formatWeekLabel } from "./week-math";
    import type { Envelope, EnvelopeWithStatus, HomePageData } from "./types";
    ```

    WEEK_OPTIONS { weekStartsOn: 0 } is already defined in week-math.ts. Use the same constant or import startOfWeek/endOfWeek with { weekStartsOn: 0 } directly.
  </implementation>
</feature>

<verification>
```bash
cd /Users/dweinbeck/Documents/dave-ramsey && npm test
```

All tests pass including:
- Existing 16 type validation tests (no regressions)
- Existing week-math tests (no regressions)
- New firestore computation tests (all passing)
</verification>

<success_criteria>
1. types.ts exports EnvelopeWithStatus and HomePageData types
2. firestore.ts exports createEnvelope, updateEnvelope, deleteEnvelope, reorderEnvelopes, listEnvelopesWithRemaining, computeCumulativeSavings
3. Pure computation helpers are tested: envelope status computation and savings computation
4. All existing tests continue to pass
5. npm test && npm run lint pass with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-envelope-management/02-01-SUMMARY.md`
</output>
