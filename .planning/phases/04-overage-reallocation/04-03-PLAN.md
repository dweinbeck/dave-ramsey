---
phase: 04-overage-reallocation
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/OverageModal.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/DonorAllocationRow.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopesHomePage.tsx
  - /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionsPage.tsx
autonomous: false

must_haves:
  truths:
    - "When a transaction causes an envelope's remaining balance to go negative, the overage modal opens automatically"
    - "Modal shows the overage amount and lists donor envelopes with remaining budgets and allocation inputs"
    - "Each donor allocation input validates against donor remaining balance, and submit is disabled until total equals overage exactly"
    - "Submitting allocations calls POST /api/envelopes/allocations and refreshes SWR caches so cards show updated balances"
    - "User can dismiss the modal without allocating (Skip for now), leaving the envelope over budget"
    - "Overage detection and modal trigger work from both EnvelopesHomePage (inline form) and TransactionsPage (full form)"
  artifacts:
    - path: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/OverageModal.tsx"
      provides: "Overage allocation workflow modal with donor form, validation summary, submit/skip"
      exports: ["OverageModal"]
      min_lines: 80
    - path: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/DonorAllocationRow.tsx"
      provides: "Single donor row with envelope title, remaining balance, dollar input, inline validation"
      exports: ["DonorAllocationRow"]
      min_lines: 30
    - path: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopesHomePage.tsx"
      provides: "Overage detection after inline transaction creation, OverageModal state management"
      contains: "setOverageContext"
    - path: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionsPage.tsx"
      provides: "Overage detection after transaction creation, OverageModal state management"
      contains: "setOverageContext"
  key_links:
    - from: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/OverageModal.tsx"
      to: "/api/envelopes/allocations"
      via: "envelopeFetch POST"
      pattern: "envelopeFetch.*allocations"
    - from: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/OverageModal.tsx"
      to: "/Users/dweinbeck/Documents/personal-brand/src/components/ui/Modal.tsx"
      via: "import Modal"
      pattern: "import.*Modal.*from.*ui/Modal"
    - from: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopesHomePage.tsx"
      to: "/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/OverageModal.tsx"
      via: "OverageModal rendered with overageContext state"
      pattern: "<OverageModal"
---

<objective>
Build the OverageModal and DonorAllocationRow components, then integrate overage detection and modal triggering into both EnvelopesHomePage and TransactionsPage.

Purpose: This is the capstone plan that delivers the user-facing overage reallocation workflow -- the signature feature of Phase 4. After this plan, users can see when an envelope goes over budget and reallocate from donor envelopes.

Output: OverageModal.tsx, DonorAllocationRow.tsx, updated EnvelopesHomePage.tsx, updated TransactionsPage.tsx.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-overage-reallocation/04-RESEARCH.md
@.planning/phases/04-overage-reallocation/04-01-SUMMARY.md
@.planning/phases/04-overage-reallocation/04-02-SUMMARY.md
@/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopesHomePage.tsx
@/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionsPage.tsx
@/Users/dweinbeck/Documents/personal-brand/src/components/envelopes/InlineTransactionForm.tsx
@/Users/dweinbeck/Documents/personal-brand/src/components/ui/Modal.tsx
@/Users/dweinbeck/Documents/personal-brand/src/components/ui/Button.tsx
@/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/api.ts
@/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts
@/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/types.ts
@/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/format.ts
@/Users/dweinbeck/Documents/personal-brand/src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DonorAllocationRow and OverageModal components</name>
  <files>
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/DonorAllocationRow.tsx
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/OverageModal.tsx
  </files>
  <action>
**1. Create DonorAllocationRow.tsx:**

A controlled component representing one donor envelope in the allocation form.

Props:
```typescript
type DonorAllocationRowProps = {
  envelopeTitle: string;
  remainingCents: number;       // donor's current remaining balance
  allocationCents: number;      // current allocation value (controlled)
  onAllocationChange: (cents: number) => void;
  error?: string;               // inline validation error message
};
```

Renders:
- Envelope title (left-aligned)
- Remaining balance display using `formatCents` (right of title, muted text)
- Dollar input field: `type="number"`, `step="0.01"`, `min="0"`, `max` computed from `remainingCents / 100`. Value displayed as dollars (allocationCents / 100 or empty string if 0). On change: convert dollars to cents via `Math.round(parseFloat(value) * 100)` and call `onAllocationChange`. Follow the same conversion pattern from `InlineTransactionForm.tsx`.
- If `error` is present, show it below the input in red text (e.g., `text-[var(--status-over)]` or similar error color from the design system).

Layout: Single row with flex, envelope info on the left, input on the right. Use Tailwind classes consistent with existing envelope components.

**2. Create OverageModal.tsx:**

The overage allocation workflow modal.

Props:
```typescript
type OverageContext = {
  transactionId: string;
  envelopeId: string;
  envelopeTitle: string;
  overageAmountCents: number;
  donorEnvelopes: { id: string; title: string; remainingCents: number }[];
};

type OverageModalProps = {
  context: OverageContext | null;   // null = modal closed
  onClose: () => void;
  onAllocated: () => void;         // called after successful allocation (refreshes caches)
  getToken: () => Promise<string>;
};
```

State:
- `allocations: Map<string, number>` -- donorEnvelopeId -> amountCents. Initialize all donors to 0.
- `isSubmitting: boolean`
- `serverError: string | null`

Behavior:
1. When `context` is not null, the Modal is open (`isOpen={context !== null}`).
2. Header: "Cover Overage" heading (use as `aria-labelledby` target with an `id`), plus a close/X button.
3. Summary line: "**{envelopeTitle}** is over budget by **{formatCents(overageAmountCents)}**"
4. Donor list: Render one `DonorAllocationRow` per donor envelope. Each row's `allocationCents` is controlled by the `allocations` map. Each row's `error` is computed by checking if `allocationCents > remainingCents` for that donor.
5. Footer summary:
   - "Allocated: {formatCents(totalAllocated)}"
   - "Remaining: {formatCents(overageAmountCents - totalAllocated)}" -- show in red if > 0, green if exactly 0
6. Two buttons in the footer:
   - "Skip for now" (secondary/ghost Button) -- calls `onClose()`
   - "Apply" (primary Button) -- disabled unless `totalAllocated === overageAmountCents` AND no per-donor errors AND not submitting. On click: submit allocations.

Submit flow:
1. Set `isSubmitting = true`, clear `serverError`.
2. Build payload: `{ sourceTransactionId: context.transactionId, allocations: entries.filter(([_, cents]) => cents > 0).map(([id, cents]) => ({ donorEnvelopeId: id, amountCents: cents })) }`
3. Call `envelopeFetch("/api/envelopes/allocations", token, { method: "POST", body: JSON.stringify(payload) })`.
4. On success: call `onAllocated()` (which will mutate SWR caches), then call `onClose()`.
5. On error: set `serverError` to the error message. Do NOT close the modal -- let the user retry or skip.
6. Set `isSubmitting = false` in `finally`.

Reset allocations to 0 for all donors when `context` changes (new overage opened).

Use the existing `envelopeFetch` helper from `@/lib/envelopes/api` for the API call.
Use `formatCents` from `@/lib/envelopes/format` for dollar display.
Use the `Button` component from `@/components/ui/Button` for actions.
Use the `Modal` component from `@/components/ui/Modal` for the dialog shell.

Styling: Match the site's design system. Use navy/gold/sage/amber CSS custom properties. The modal content should have padding (`p-6`), the header and footer should be visually distinct sections. Follow existing Tailwind patterns from EnvelopeCard and EnvelopeForm.
  </action>
  <verify>
```bash
cd /Users/dweinbeck/Documents/personal-brand
npx tsc --noEmit
npx biome check src/components/envelopes/OverageModal.tsx src/components/envelopes/DonorAllocationRow.tsx
grep "export function OverageModal" src/components/envelopes/OverageModal.tsx
grep "export function DonorAllocationRow" src/components/envelopes/DonorAllocationRow.tsx
```
  </verify>
  <done>
- DonorAllocationRow renders donor info with dollar input and inline validation
- OverageModal wraps Modal component, manages allocation state, validates in real-time, submits to allocation API
- Footer shows allocated vs remaining with visual feedback
- User can skip (dismiss) or apply (submit) allocations
- TypeScript and Biome clean
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate overage detection and modal into EnvelopesHomePage and TransactionsPage</name>
  <files>
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/EnvelopesHomePage.tsx
    /Users/dweinbeck/Documents/personal-brand/src/components/envelopes/TransactionsPage.tsx
  </files>
  <action>
**In both EnvelopesHomePage.tsx and TransactionsPage.tsx:**

1. **Add OverageContext state:**
```typescript
const [overageContext, setOverageContext] = useState<OverageContext | null>(null);
```
Import the `OverageContext` type from `OverageModal.tsx` (export it from there).

2. **Add overage detection after transaction creation:**

In the existing transaction creation handler (e.g., `handleInlineTransaction` in EnvelopesHomePage, `handleCreate` in TransactionsPage), after the successful `POST /api/envelopes/transactions` call:

```typescript
// After creating transaction, refresh envelopes to get updated balances
// CRITICAL: Use the return value of mutate(), not the stale `data` variable
const freshData = await mutateEnvelopes();

// Check if the target envelope is now over budget
if (freshData) {
  const targetEnvelope = freshData.envelopes.find(
    (e) => e.id === txnData.envelopeId,  // use the envelopeId from the transaction
  );
  if (targetEnvelope && targetEnvelope.remainingCents < 0) {
    setOverageContext({
      transactionId: createdTxn.id,
      envelopeId: targetEnvelope.id,
      envelopeTitle: targetEnvelope.title,
      overageAmountCents: Math.abs(targetEnvelope.remainingCents),
      donorEnvelopes: freshData.envelopes
        .filter((e) => e.id !== targetEnvelope.id && e.remainingCents > 0)
        .map((e) => ({
          id: e.id,
          title: e.title,
          remainingCents: e.remainingCents,
        })),
    });
    return; // Don't collapse the form or navigate -- modal is now open
  }
}
```

**For EnvelopesHomePage:** This goes in the inline transaction creation handler. After overage detection, if no overage, proceed with the existing behavior (collapse expanded card, etc.).

**For TransactionsPage:** This goes in the transaction creation handler. After overage detection, if no overage, proceed with existing behavior (refresh transaction list, clear form, etc.). Also refresh transactions SWR after allocation succeeds.

The `mutateEnvelopes` reference: In EnvelopesHomePage, the SWR hook already provides `mutate`. In TransactionsPage, import and call `mutate` from useEnvelopes if not already available. Check what hooks are already used in each page and use the existing `mutate` function.

3. **Add `onAllocated` callback:**

```typescript
function handleAllocated() {
  // Refresh both SWR caches so balances reflect the new allocations
  mutateEnvelopes();
  // In TransactionsPage, also mutate transactions if available
}
```

4. **Render OverageModal:**

Add at the bottom of the component JSX (before the closing fragment):
```tsx
<OverageModal
  context={overageContext}
  onClose={() => setOverageContext(null)}
  onAllocated={handleAllocated}
  getToken={getToken}
/>
```

Where `getToken` comes from the existing auth context (`useAuth()`), which is already imported in both pages.

5. **Handle the `return` value from `mutate()`:**

The SWR `mutate()` function returns `Promise<Data | undefined>`. The return value is the fresh data after revalidation. Use this directly for the overage check:
```typescript
const freshData = await mutate(); // returns HomePageData | undefined
```

Do NOT use the stale `data` from `const { data, mutate } = useEnvelopes(...)` for the check. The `data` variable may not be updated yet when the overage check runs.

6. **Import OverageModal:**
```typescript
import { OverageModal, type OverageContext } from "./OverageModal";
```
  </action>
  <verify>
```bash
cd /Users/dweinbeck/Documents/personal-brand
npx tsc --noEmit
npx biome check src/components/envelopes/EnvelopesHomePage.tsx src/components/envelopes/TransactionsPage.tsx
grep "OverageModal" src/components/envelopes/EnvelopesHomePage.tsx
grep "OverageModal" src/components/envelopes/TransactionsPage.tsx
grep "setOverageContext" src/components/envelopes/EnvelopesHomePage.tsx
grep "setOverageContext" src/components/envelopes/TransactionsPage.tsx
```
  </verify>
  <done>
- Both pages detect overage after transaction creation using fresh mutate() return value
- Both pages render OverageModal with context state
- Modal opens automatically when remainingCents < 0
- onAllocated refreshes SWR caches for immediate balance updates
- TypeScript and Biome clean
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete overage reallocation workflow: when a transaction causes an envelope to go negative, an overage modal opens showing donor envelopes with remaining budgets, validation of allocation amounts, and atomic persistence of allocations with balance updates.</what-built>
  <how-to-verify>
1. Start the dev server: `cd /Users/dweinbeck/Documents/personal-brand && npm run dev`
2. Navigate to `/envelopes`
3. Create an envelope "Groceries" with a $100/week budget
4. Create another envelope "Dining" with a $50/week budget
5. On the home page, expand "Groceries" and add a transaction for $120 (this exceeds the $100 budget)
6. Verify: An overage modal should appear automatically showing:
   - "Groceries is over budget by $20.00" (or similar)
   - "Dining" listed as a donor with $50.00 remaining
   - An allocation input field
7. Enter $20.00 in the Dining allocation field
8. Verify: "Allocated: $20.00 / Remaining: $0.00" in the footer, "Apply" button enabled
9. Click "Apply"
10. Verify: Modal closes, Groceries card shows updated remaining ($0.00 after allocation covers the overage), Dining card shows $30.00 remaining ($50 - $20 donated)
11. Test dismissal: Add another over-budget transaction, click "Skip for now" -- modal closes, envelope shows "Over" status
12. Test from Transactions page: Navigate to `/envelopes/transactions`, add an over-budget transaction -- same overage modal should appear
13. Test cascade delete: Delete the transaction that triggered allocations -- donor envelope balance should restore
14. Press Escape while modal is open -- modal should close cleanly
15. Click the backdrop -- modal should close cleanly
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
```bash
cd /Users/dweinbeck/Documents/personal-brand

# TypeScript compiles
npx tsc --noEmit

# Lint clean
npx biome check src/components/envelopes/OverageModal.tsx src/components/envelopes/DonorAllocationRow.tsx src/components/envelopes/EnvelopesHomePage.tsx src/components/envelopes/TransactionsPage.tsx

# Build succeeds
npm run build

# Key components exist and export correctly
grep "export function OverageModal" src/components/envelopes/OverageModal.tsx
grep "export function DonorAllocationRow" src/components/envelopes/DonorAllocationRow.tsx
grep "OverageModal" src/components/envelopes/EnvelopesHomePage.tsx
grep "OverageModal" src/components/envelopes/TransactionsPage.tsx
grep "setOverageContext" src/components/envelopes/EnvelopesHomePage.tsx
```
</verification>

<success_criteria>
1. When a transaction causes remainingCents < 0, the overage modal opens automatically on both pages
2. Modal shows overage amount, donor envelopes with remaining balances, and allocation inputs
3. Each donor input validates: amount cannot exceed donor remaining
4. Submit is disabled until total allocations exactly equal overage amount
5. Successful allocation submission refreshes both SWR caches, balances update immediately
6. User can dismiss modal without allocating ("Skip for now")
7. Escape key and backdrop click close the modal cleanly
8. TypeScript compiles, Biome lint passes, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-overage-reallocation/04-03-SUMMARY.md`
</output>
