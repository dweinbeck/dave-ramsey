---
phase: 05-analytics
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/types.ts
  - /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/firestore.ts
  - /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/week-math.ts
  - /Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/analytics/route.ts
  - /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts

autonomous: true

must_haves:
  truths:
    - "GET /api/envelopes/analytics returns JSON with summary, envelopes, pivotRows, and savingsByWeek fields"
    - "Analytics endpoint computes all data server-side from a single batch of Firestore queries (no N+1)"
    - "useAnalytics() SWR hook fetches analytics data for the authenticated user"
    - "Recharts is installed and available for import in personal-brand repo"
  artifacts:
    - path: "/Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/analytics/route.ts"
      provides: "GET handler for analytics endpoint"
      exports: ["GET"]
    - path: "/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts"
      provides: "useAnalytics SWR hook"
      contains: "useAnalytics"
    - path: "/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/firestore.ts"
      provides: "getAnalyticsData server function, computeWeeklySavingsBreakdown, buildPivotRows"
      contains: "getAnalyticsData"
  key_links:
    - from: "/Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/analytics/route.ts"
      to: "getAnalyticsData"
      via: "import from firestore.ts"
      pattern: "getAnalyticsData"
    - from: "/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/firestore.ts"
      to: "computeWeeklySavingsBreakdown"
      via: "calls pure computation helper for savings breakdown"
      pattern: "computeWeeklySavingsBreakdown"
    - from: "/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts"
      to: "/api/envelopes/analytics"
      via: "SWR fetcher with envelopeFetch"
      pattern: "envelopes/analytics"
---

<objective>
Create the analytics API endpoint, server-side aggregation function, SWR hook, and install Recharts in the personal-brand repo.

Purpose: This plan wires up the data pipeline from Firestore to the client. The analytics page UI (Plan 05-03) depends on this API endpoint and hook existing.

Output: A working `GET /api/envelopes/analytics` endpoint returning `AnalyticsPageData`, a `useAnalytics()` SWR hook, and Recharts available as a dependency.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-analytics/05-01-SUMMARY.md

@/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/firestore.ts
@/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/types.ts
@/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts
@/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/week-math.ts
@/Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Copy updated utilities + Install Recharts</name>
  <files>
    /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/types.ts
    /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/firestore.ts
    /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/week-math.ts
  </files>
  <action>
1. Copy the updated type definitions from dave-ramsey `types.ts` into personal-brand `types.ts`. Specifically, add the new analytics types (WeeklySavingsEntry, PivotRow, AnalyticsPageData) at the bottom. Do NOT replace the entire file -- personal-brand types.ts may have minor differences (Timestamp import path). Only append the new analytics types section.

2. Copy the new pure functions (`computeWeeklySavingsBreakdown`, `buildPivotRows`) from dave-ramsey `firestore.ts` into personal-brand `firestore.ts` in the pure computation helpers section. Also ensure `getWeekNumber` is imported from `./week-math` and the new types are imported from `./types`.

3. Ensure `getWeekNumber` exists in personal-brand `week-math.ts`. If not, copy it from dave-ramsey.

4. Install Recharts in the personal-brand repo:
```bash
cd /Users/dweinbeck/Documents/personal-brand && npm install recharts
```

Verify installation: `grep recharts /Users/dweinbeck/Documents/personal-brand/package.json`
  </action>
  <verify>
`npx tsc --noEmit` passes in personal-brand repo.
`grep "recharts" /Users/dweinbeck/Documents/personal-brand/package.json` shows the dependency.
  </verify>
  <done>Analytics types, pure computation helpers, and Recharts are available in personal-brand repo.</done>
</task>

<task type="auto">
  <name>Task 2: Analytics API route + getAnalyticsData + useAnalytics hook</name>
  <files>
    /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/firestore.ts
    /Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/analytics/route.ts
    /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts
  </files>
  <action>
**Add `getAnalyticsData` to personal-brand's firestore.ts:**

Create an async function that computes all analytics data in one shot. Follow this logic:

```typescript
export async function getAnalyticsData(userId: string): Promise<AnalyticsPageData> {
  const today = new Date();
  const { start, end } = getWeekRange(today);
  const weekStartStr = format(start, "yyyy-MM-dd");
  const weekEndStr = format(end, "yyyy-MM-dd");

  // 1. Parallel fetch: envelopes + current-week transactions + ALL transactions
  const [envSnap, currentTxSnap, allTxSnap] = await Promise.all([
    envelopesForUser(userId).get(),
    transactionsForUserInWeek(userId, weekStartStr, weekEndStr).get(),
    transactionsCol().where("userId", "==", userId).get(),
  ]);

  // 2. Parse envelope data
  const envelopeHeaders = envSnap.docs.map(doc => ({
    id: doc.id,
    title: doc.data().title as string,
  }));

  const envelopeData = envSnap.docs.map(doc => {
    const data = doc.data();
    const createdAt = data.createdAt?.toDate?.() ?? new Date();
    return {
      id: doc.id,
      weeklyBudgetCents: data.weeklyBudgetCents as number,
      rollover: data.rollover as boolean,
      createdAt: format(createdAt, "yyyy-MM-dd"),
    };
  });

  // 3. Compute SUMMARY from current-week transactions
  const spentByEnvelope = new Map<string, number>();
  for (const doc of currentTxSnap.docs) {
    const data = doc.data();
    const envId = data.envelopeId as string;
    spentByEnvelope.set(envId, (spentByEnvelope.get(envId) ?? 0) + (data.amountCents as number));
  }

  let totalSpentCents = 0;
  let totalBudgetCents = 0;
  let onTrackCount = 0;

  for (const env of envelopeData) {
    const spent = spentByEnvelope.get(env.id) ?? 0;
    totalSpentCents += spent;
    totalBudgetCents += env.weeklyBudgetCents;
    const { status } = computeEnvelopeStatus(env.weeklyBudgetCents, spent, today);
    if (status === "On Track") onTrackCount++;
  }

  const summary = {
    totalSpentCents,
    totalBudgetCents,
    totalRemainingCents: totalBudgetCents - totalSpentCents,
    onTrackCount,
    totalEnvelopeCount: envelopeData.length,
  };

  // 4. Parse ALL transactions for pivot table and savings
  const allTransactions = allTxSnap.docs.map(doc => {
    const data = doc.data();
    return {
      envelopeId: data.envelopeId as string,
      amountCents: data.amountCents as number,
      date: data.date as string,
    };
  });

  // 5. Compute PIVOT TABLE
  // Find earliest transaction date's week start, or earliest envelope createdAt
  let earliestDate = weekStartStr;
  for (const env of envelopeData) {
    if (env.createdAt < earliestDate) earliestDate = env.createdAt;
  }
  for (const tx of allTransactions) {
    if (tx.date < earliestDate) earliestDate = tx.date;
  }
  const earliestWeekStart = format(startOfWeek(new Date(earliestDate + "T00:00:00"), WEEK_OPTIONS), "yyyy-MM-dd");

  const pivotRows = buildPivotRows(allTransactions, earliestWeekStart, weekEndStr);

  // 6. Compute SAVINGS BREAKDOWN
  const currentWeekStartStr = weekStartStr;
  const savingsByWeek = computeWeeklySavingsBreakdown(
    envelopeData,
    allTransactions,
    earliestWeekStart,
    currentWeekStartStr,
  );

  return { summary, envelopes: envelopeHeaders, pivotRows, savingsByWeek };
}
```

NOTE on summary: The summary does NOT account for overage allocations in the on-track count. This is a simplification for the analytics overview -- the home page shows allocation-adjusted status. Document this in a code comment. The `totalRemainingCents` is budget minus raw spending, which matches the pivot table's perspective (raw transaction totals).

**Create API route at `src/app/api/envelopes/analytics/route.ts`:**

Follow the exact same pattern as the existing `src/app/api/envelopes/route.ts` GET handler:

```typescript
import { NextRequest, NextResponse } from "next/server";
import { verifyUser } from "@/lib/auth/verifyUser";
import { getAnalyticsData } from "@/lib/envelopes/firestore";

export async function GET(request: NextRequest) {
  try {
    const user = await verifyUser(request);
    if (!user) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }
    const data = await getAnalyticsData(user.uid);
    return NextResponse.json(data);
  } catch (error) {
    const message = error instanceof Error ? error.message : "Internal server error";
    console.error("Analytics API error:", message);
    return NextResponse.json({ error: message }, { status: 500 });
  }
}
```

Do NOT log request bodies or user data (privacy constraint).

**Add `useAnalytics` hook to hooks.ts:**

Append to the existing hooks.ts file. Follow the exact same pattern as `useEnvelopes` and `useTransactions`:

```typescript
export function useAnalytics() {
  const { user } = useAuth();

  const { data, error, isLoading } = useSWR<AnalyticsPageData>(
    user ? "/api/envelopes/analytics" : null,
    async (url: string) => {
      const token = await user?.getIdToken();
      if (!token) throw new Error("Not authenticated");
      return envelopeFetch<AnalyticsPageData>(url, token);
    },
  );

  return { data, error, isLoading };
}
```

Import `AnalyticsPageData` from `./types` at the top of hooks.ts (add to existing import).
  </action>
  <verify>
`npx tsc --noEmit` passes in personal-brand repo.
`grep "getAnalyticsData" /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/firestore.ts` returns a match.
`grep "useAnalytics" /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts` returns a match.
`ls /Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/analytics/route.ts` confirms the file exists.
  </verify>
  <done>
Analytics API endpoint returns AnalyticsPageData JSON for authenticated users.
useAnalytics() hook available for client components.
Server-side aggregation uses parallel Firestore queries (no N+1).
  </done>
</task>

</tasks>

<verification>
1. `npm run build` passes in personal-brand repo (or at minimum `npx tsc --noEmit`)
2. `grep "recharts" /Users/dweinbeck/Documents/personal-brand/package.json` shows dependency
3. API route file exists at `src/app/api/envelopes/analytics/route.ts`
4. `useAnalytics` hook exists in hooks.ts
5. `getAnalyticsData` function exists in firestore.ts
6. No privacy violations: no request body logging, no user data in error messages
</verification>

<success_criteria>
- GET /api/envelopes/analytics endpoint exists and exports GET handler
- getAnalyticsData computes summary, pivot rows, and savings breakdown from parallel Firestore queries
- useAnalytics() SWR hook fetches and returns AnalyticsPageData
- Recharts installed in personal-brand package.json
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-analytics/05-02-SUMMARY.md`
</output>
