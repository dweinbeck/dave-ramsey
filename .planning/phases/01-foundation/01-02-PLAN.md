---
phase: 01-foundation
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/envelopes/week-math.ts
  - src/lib/envelopes/__tests__/week-math.test.ts
autonomous: true

must_haves:
  truths:
    - "getWeekRange returns Sunday-to-Saturday range for any given date"
    - "getRemainingDaysPercent returns 1.0 on Sunday and decreasing fractions through the week"
    - "getStatusLabel returns 'Over' when remaining is zero or negative"
    - "getStatusLabel returns 'On Track' when remaining >= proportional budget"
    - "getStatusLabel returns 'Watch' when remaining is positive but below proportional budget"
    - "formatWeekLabel formats a date into 'M/D/YYYY - M/D/YYYY' range string"
  artifacts:
    - path: "src/lib/envelopes/week-math.ts"
      provides: "Week math utilities (single source of truth)"
      exports: ["getWeekRange", "getRemainingDaysPercent", "getStatusLabel", "formatWeekLabel"]
      min_lines: 40
    - path: "src/lib/envelopes/__tests__/week-math.test.ts"
      provides: "Comprehensive tests for all week math functions"
      contains: "describe"
      min_lines: 60
  key_links:
    - from: "src/lib/envelopes/week-math.ts"
      to: "date-fns"
      via: "import startOfWeek, endOfWeek, differenceInCalendarDays, format"
      pattern: "from \"date-fns\""
---

<objective>
Build and test the week math utilities that are the single source of truth for all date calculations in Digital Envelopes.

Purpose: Every feature in the app depends on correct week boundary computation. TDD ensures edge cases (year boundaries, DST transitions, mid-week dates) are covered before any UI or API code uses these functions.

Output: Fully tested `week-math.ts` with `getWeekRange`, `getRemainingDaysPercent`, `getStatusLabel`, and `formatWeekLabel`.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md

# Test pattern reference:
@src/lib/billing/__tests__/types.test.ts

# Vitest config:
@vitest.config.ts
</context>

<feature>
  <name>Week Math Utilities</name>
  <files>
    src/lib/envelopes/week-math.ts
    src/lib/envelopes/__tests__/week-math.test.ts
  </files>
  <behavior>
    **IMPORTANT: Install `date-fns` first.** Run `npm install date-fns` before writing any code. This is the only new dependency for the entire project.

    All functions use `weekStartsOn: 0` (Sunday) consistently.

    **getWeekRange(date: Date) -> { start: Date; end: Date }**
    - Input: any Date -> Output: { start: Sunday 00:00:00, end: Saturday 23:59:59.999 }
    - Cases:
      - Sunday 2026-02-08 -> start: Sun Feb 8, end: Sat Feb 14
      - Wednesday 2026-02-11 -> start: Sun Feb 8, end: Sat Feb 14
      - Saturday 2026-02-14 -> start: Sun Feb 8, end: Sat Feb 14
      - Year boundary: Wednesday 2025-12-31 -> start: Sun Dec 28, end: Sat Jan 3

    **getRemainingDaysPercent(today: Date) -> number**
    - Input: any Date -> Output: fraction of week remaining (0 < result <= 1)
    - Cases:
      - Sunday -> 7/7 = 1.0
      - Monday -> 6/7 ≈ 0.857
      - Wednesday -> 4/7 ≈ 0.571
      - Saturday -> 1/7 ≈ 0.143

    **getStatusLabel(remainingCents, weeklyBudgetCents, remainingDaysPercent) -> "On Track" | "Watch" | "Over"**
    - Cases:
      - remainingCents <= 0 -> "Over" (regardless of other params)
      - remainingCents = 0 -> "Over"
      - remainingCents = -500 -> "Over"
      - remainingCents >= weeklyBudgetCents * remainingDaysPercent -> "On Track"
        - e.g., remaining=5000, budget=10000, percent=0.5 -> proportional=5000 -> "On Track"
      - 0 < remainingCents < weeklyBudgetCents * remainingDaysPercent -> "Watch"
        - e.g., remaining=2000, budget=10000, percent=0.5 -> proportional=5000 -> "Watch"
      - Edge: remaining=1, budget=10000, percent=0.0001 -> proportional=1 -> "On Track"
      - Full budget on Sunday: remaining=10000, budget=10000, percent=1.0 -> "On Track"

    **formatWeekLabel(date: Date) -> string**
    - Input: any Date -> Output: "M/D/YYYY - M/D/YYYY"
    - Cases:
      - Wednesday 2026-02-11 -> "2/8/2026 - 2/14/2026"
      - Year boundary 2025-12-31 -> "12/28/2025 - 1/3/2026"
  </behavior>
  <implementation>
    Use `date-fns` v4: `startOfWeek`, `endOfWeek`, `differenceInCalendarDays`, `format`.
    Define `const WEEK_OPTIONS = { weekStartsOn: 0 as const }` once at module level.
    Follow the exact implementation from the RESEARCH.md code examples section.
    Export all four functions as named exports.
    No default export.
  </implementation>
</feature>

<verification>
1. `npm test -- src/lib/envelopes/__tests__/week-math.test.ts` -- all tests pass
2. `npm run build` -- no TypeScript errors (date-fns types resolve correctly)
3. `npm run lint` -- no Biome errors
4. Test coverage: at least 4 test cases for getWeekRange, 4 for getRemainingDaysPercent, 6 for getStatusLabel, 2 for formatWeekLabel
</verification>

<success_criteria>
- All four functions exported from `week-math.ts`
- All tests pass (RED -> GREEN cycle completed)
- Edge cases covered: year boundary, week boundaries (Sunday and Saturday), zero/negative remaining
- `date-fns` installed and importable
- Build and lint pass with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
