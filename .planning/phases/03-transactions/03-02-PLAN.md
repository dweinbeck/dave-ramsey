---
phase: 03-transactions
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  # dave-ramsey repo
  - src/lib/envelopes/firestore.ts
  # personal-brand repo
  - /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/types.ts
  - /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/firestore.ts
  - /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/week-math.ts
  - /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts
  - /Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/transactions/route.ts
  - /Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/transactions/[transactionId]/route.ts
autonomous: true

must_haves:
  truths:
    - "Transaction can be created with userId, envelopeId, amountCents, date, optional merchant/description"
    - "Transaction can be updated with any subset of fields, with ownership verification"
    - "Transaction can be deleted with ownership verification"
    - "Transactions can be listed for a specific user within a date range"
    - "API routes enforce auth via verifyUser on every request"
    - "useTransactions hook fetches transactions for a week range with SWR caching"
  artifacts:
    - path: "/Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/transactions/route.ts"
      provides: "GET (list by week) and POST (create) transaction endpoints"
      exports: ["GET", "POST"]
    - path: "/Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/transactions/[transactionId]/route.ts"
      provides: "PUT (update) and DELETE transaction endpoints"
      exports: ["PUT", "DELETE"]
    - path: "/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts"
      provides: "useTransactions SWR hook keyed by week range"
      exports: ["useTransactions"]
  key_links:
    - from: "/Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/transactions/route.ts"
      to: "/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/firestore.ts"
      via: "import createTransaction, listTransactionsForWeek"
      pattern: "createTransaction|listTransactionsForWeek"
    - from: "/Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/transactions/[transactionId]/route.ts"
      to: "/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/firestore.ts"
      via: "import updateTransaction, deleteTransaction"
      pattern: "updateTransaction|deleteTransaction"
    - from: "/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts"
      to: "/api/envelopes/transactions"
      via: "SWR fetch with weekStart/weekEnd query params"
      pattern: "api/envelopes/transactions\\?weekStart"
---

<objective>
Add transaction CRUD functions to Firestore helpers in both repos, create transaction API routes in personal-brand, add useTransactions SWR hook, and sync types/utilities from dave-ramsey to personal-brand.

Purpose: Provides the data layer and API surface for all transaction operations. The UI (Plan 03) will consume these endpoints and hooks.
Output: 4 API route handlers (GET, POST, PUT, DELETE), 4 Firestore CRUD functions, 1 SWR hook, synced types
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-transactions/03-RESEARCH.md
@.planning/phases/03-transactions/03-01-SUMMARY.md

Key existing patterns to replicate:
- /Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/route.ts -- GET/POST pattern with verifyUser
- /Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/[envelopeId]/route.ts -- PUT/DELETE pattern with params
- /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts -- useEnvelopes SWR hook pattern
- /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/api.ts -- envelopeFetch helper
- /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/firestore.ts -- existing CRUD functions

Cross-repo: dave-ramsey utilities are COPIED into personal-brand (not imported cross-repo).
Decision [02-02]: Copied dave-ramsey utilities into personal-brand repo.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Transaction CRUD functions in both repos</name>
  <files>
    src/lib/envelopes/firestore.ts (dave-ramsey repo)
    /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/firestore.ts
  </files>
  <action>
    Add four transaction CRUD functions to firestore.ts in BOTH repos (dave-ramsey first, then copy to personal-brand). Add them after the existing `reorderEnvelopes` function, before `listEnvelopesWithRemaining`.

    **1. createTransaction:**
    ```typescript
    import type { EnvelopeTransaction, TransactionInput } from "./types";

    export async function createTransaction(
      userId: string,
      input: TransactionInput,
    ): Promise<EnvelopeTransaction> {
      // Verify the envelope exists and belongs to the user
      const envRef = envelopesCol().doc(input.envelopeId);
      const envSnap = await envRef.get();
      if (!envSnap.exists || envSnap.data()?.userId !== userId) {
        throw new Error("Envelope not found or access denied.");
      }

      const docRef = transactionsCol().doc();
      const data = {
        userId,
        envelopeId: input.envelopeId,
        amountCents: input.amountCents,
        date: input.date,
        ...(input.merchant ? { merchant: input.merchant } : {}),
        ...(input.description ? { description: input.description } : {}),
        createdAt: FieldValue.serverTimestamp(),
        updatedAt: FieldValue.serverTimestamp(),
      };

      await docRef.set(data);
      const snap = await docRef.get();
      return { id: docRef.id, ...snap.data() } as EnvelopeTransaction;
    }
    ```

    **2. updateTransaction:**
    ```typescript
    import type { TransactionUpdateInput } from "./types";

    export async function updateTransaction(
      userId: string,
      transactionId: string,
      input: TransactionUpdateInput,
    ): Promise<void> {
      const docRef = transactionsCol().doc(transactionId);
      const snap = await docRef.get();
      if (!snap.exists || snap.data()?.userId !== userId) {
        throw new Error("Transaction not found or access denied.");
      }

      // If changing envelope, verify the new envelope belongs to the user
      if (input.envelopeId) {
        const envRef = envelopesCol().doc(input.envelopeId);
        const envSnap = await envRef.get();
        if (!envSnap.exists || envSnap.data()?.userId !== userId) {
          throw new Error("Envelope not found or access denied.");
        }
      }

      const updateData: Record<string, unknown> = {
        updatedAt: FieldValue.serverTimestamp(),
      };
      if (input.envelopeId !== undefined) updateData.envelopeId = input.envelopeId;
      if (input.amountCents !== undefined) updateData.amountCents = input.amountCents;
      if (input.date !== undefined) updateData.date = input.date;
      if (input.merchant !== undefined) updateData.merchant = input.merchant;
      if (input.description !== undefined) updateData.description = input.description;

      await docRef.update(updateData);
    }
    ```

    **3. deleteTransaction:**
    ```typescript
    export async function deleteTransaction(
      userId: string,
      transactionId: string,
    ): Promise<void> {
      const docRef = transactionsCol().doc(transactionId);
      const snap = await docRef.get();
      if (!snap.exists || snap.data()?.userId !== userId) {
        throw new Error("Transaction not found or access denied.");
      }

      // TODO: Phase 4 will add cascade-delete of related overage allocations here.
      await docRef.delete();
    }
    ```

    **4. listTransactionsForWeek:**
    ```typescript
    export async function listTransactionsForWeek(
      userId: string,
      weekStart: string,
      weekEnd: string,
    ): Promise<{ transactions: EnvelopeTransaction[] }> {
      const snap = await transactionsForUserInWeek(userId, weekStart, weekEnd)
        .orderBy("date", "desc")
        .get();

      const transactions = snap.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      })) as EnvelopeTransaction[];

      return { transactions };
    }
    ```

    **Import updates:** Add `EnvelopeTransaction`, `TransactionInput`, and `TransactionUpdateInput` to the types import in both repos' firestore.ts.

    **IMPORTANT for dave-ramsey repo:** The types.ts there does NOT yet have `transactionUpdateSchema` / `TransactionUpdateInput` / `TransactionsPageData` -- Plan 03-01 adds those. If 03-01 has already run, those types will exist. If not, add the `TransactionUpdateInput` import type inline or ensure 03-01 runs first.
  </action>
  <verify>
    ```bash
    cd /Users/dweinbeck/Documents/dave-ramsey && npx tsc --noEmit
    ```
    TypeScript compiles without errors in dave-ramsey repo.
  </verify>
  <done>
    - createTransaction, updateTransaction, deleteTransaction, listTransactionsForWeek exported from firestore.ts in both repos
    - All functions verify userId ownership before mutation
    - createTransaction verifies envelope ownership
    - updateTransaction verifies new envelope ownership when envelopeId changes
    - deleteTransaction has TODO comment for Phase 4 cascade
  </done>
</task>

<task type="auto">
  <name>Task 2: Sync types/utilities + API routes + SWR hook in personal-brand</name>
  <files>
    /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/types.ts
    /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/week-math.ts
    /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts
    /Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/transactions/route.ts
    /Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/transactions/[transactionId]/route.ts
  </files>
  <action>
    **1. Sync types to personal-brand:**

    In `/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/types.ts`, add after `transactionSchema` / `TransactionInput`:

    ```typescript
    /** Transaction partial update payload (all fields optional). */
    export const transactionUpdateSchema = z.object({
      envelopeId: z.string().min(1).optional(),
      amountCents: z.number().int().min(1).optional(),
      date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, "Date must be YYYY-MM-DD").optional(),
      merchant: z.string().max(200).optional(),
      description: z.string().max(500).optional(),
    });
    export type TransactionUpdateInput = z.infer<typeof transactionUpdateSchema>;
    ```

    At the bottom of the file, add:
    ```typescript
    /** Response shape for GET /api/envelopes/transactions?weekStart=...&weekEnd=... */
    export type TransactionsPageData = {
      transactions: EnvelopeTransaction[];
    };
    ```

    **2. Sync getWeekNumber to personal-brand:**

    In `/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/week-math.ts`, add `getWeek` to the date-fns import and add the function:
    ```typescript
    import { getWeek } from "date-fns"; // add to existing import

    export function getWeekNumber(date: Date): number {
      return getWeek(date, { weekStartsOn: 0, firstWeekContainsDate: 1 });
    }
    ```

    **3. Create transaction API routes:**

    Create `/Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/transactions/route.ts`:
    Follow the EXACT pattern from `/api/envelopes/route.ts`. Use `verifyUser` + `unauthorizedResponse` from `@/lib/auth/user`.

    - **GET handler:** Extract `weekStart` and `weekEnd` from URL search params. Return 400 if missing. Call `listTransactionsForWeek(auth.uid, weekStart, weekEnd)`. Return the result as JSON. Error log format: `"GET /api/envelopes/transactions error:"` + `error.message` only (no request body per privacy rules).

    - **POST handler:** Parse body with `transactionSchema.safeParse(body)`. Call `createTransaction(auth.uid, parsed.data)`. Return 201. Error log format: `"POST /api/envelopes/transactions error:"` + `error.message` only.

    Create `/Users/dweinbeck/Documents/personal-brand/src/app/api/envelopes/transactions/[transactionId]/route.ts`:
    Follow the EXACT pattern from `/api/envelopes/[envelopeId]/route.ts`.

    - **PUT handler:** Params type is `{ params: Promise<{ transactionId: string }> }`. Parse body with `transactionUpdateSchema.safeParse(body)`. Call `updateTransaction(auth.uid, transactionId, parsed.data)`. Return `{ success: true }`. Catch "Transaction not found or access denied." and return 404.

    - **DELETE handler:** Same params. Call `deleteTransaction(auth.uid, transactionId)`. Return `{ success: true }`. Catch "Transaction not found or access denied." and return 404.

    **4. Add useTransactions SWR hook:**

    In `/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/hooks.ts`, add:
    ```typescript
    import type { TransactionsPageData } from "@/lib/envelopes/types";

    export function useTransactions(weekStart: string, weekEnd: string) {
      const { user } = useAuth();

      const { data, error, isLoading, mutate } = useSWR<TransactionsPageData>(
        user ? `/api/envelopes/transactions?weekStart=${weekStart}&weekEnd=${weekEnd}` : null,
        async (url: string) => {
          const token = await user?.getIdToken();
          if (!token) throw new Error("Not authenticated");
          return envelopeFetch<TransactionsPageData>(url, token);
        },
      );

      return { data, error, isLoading, mutate };
    }
    ```

    **IMPORTANT:** Ensure the hook is keyed by both weekStart AND weekEnd so navigating weeks fetches fresh data.
  </action>
  <verify>
    ```bash
    cd /Users/dweinbeck/Documents/personal-brand && npm run build
    ```
    Build succeeds without TypeScript errors. API route files are valid.
  </verify>
  <done>
    - transactionUpdateSchema, TransactionUpdateInput, TransactionsPageData synced to personal-brand types.ts
    - getWeekNumber synced to personal-brand week-math.ts
    - GET /api/envelopes/transactions returns transactions filtered by weekStart/weekEnd query params
    - POST /api/envelopes/transactions creates a transaction with Zod validation and auth
    - PUT /api/envelopes/transactions/[transactionId] updates a transaction with partial fields
    - DELETE /api/envelopes/transactions/[transactionId] deletes a transaction with auth verification
    - useTransactions(weekStart, weekEnd) SWR hook exported from hooks.ts
    - All API routes use verifyUser for auth and privacy-safe error logging
  </done>
</task>

</tasks>

<verification>
```bash
# dave-ramsey repo: TypeScript check + tests
cd /Users/dweinbeck/Documents/dave-ramsey && npx tsc --noEmit && npm test

# personal-brand repo: full build
cd /Users/dweinbeck/Documents/personal-brand && npm run build
```
- dave-ramsey: TypeScript compiles, all tests pass
- personal-brand: Build succeeds with no errors
- All new functions and routes follow existing auth/privacy patterns
</verification>

<success_criteria>
- 4 Firestore CRUD functions (create, update, delete, list) in both repos
- 4 API route handlers (GET, POST, PUT, DELETE) in personal-brand
- useTransactions SWR hook in personal-brand
- Types and utilities synced from dave-ramsey to personal-brand
- All builds pass in both repos
</success_criteria>

<output>
After completion, create `.planning/phases/03-transactions/03-02-SUMMARY.md`
</output>
