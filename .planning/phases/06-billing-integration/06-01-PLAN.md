---
phase: 06-billing-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /Users/dweinbeck/Documents/dave-ramsey/src/lib/envelopes/types.ts
  - /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/types.ts
  - /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/billing.ts
  - /Users/dweinbeck/Documents/personal-brand/src/lib/billing/tools.ts
autonomous: true

must_haves:
  truths:
    - "checkEnvelopeAccess() returns readwrite with reason free_week when user's first access is in the current calendar week"
    - "checkEnvelopeAccess() returns readwrite after successful debitForToolUse() charge of 100 credits"
    - "checkEnvelopeAccess() returns readonly with reason unpaid when user has insufficient credits (402 from debitForToolUse)"
    - "checkEnvelopeAccess() returns readwrite without re-charging when paidWeeks already contains current week"
    - "dave_ramsey tool pricing is active: true with creditsPerUse: 100"
  artifacts:
    - path: "/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/billing.ts"
      provides: "checkEnvelopeAccess function wrapping debitForToolUse with free-week and paid-week tracking"
      exports: ["checkEnvelopeAccess"]
    - path: "/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/types.ts"
      provides: "EnvelopeBilling and EnvelopeAccessResult types"
      contains: "EnvelopeAccessResult"
    - path: "/Users/dweinbeck/Documents/personal-brand/src/lib/billing/tools.ts"
      provides: "Updated dave_ramsey tool pricing"
      contains: "creditsPerUse: 100"
  key_links:
    - from: "src/lib/envelopes/billing.ts"
      to: "src/lib/billing/firestore.ts"
      via: "import debitForToolUse"
      pattern: "debitForToolUse"
    - from: "src/lib/envelopes/billing.ts"
      to: "src/lib/envelopes/week-math.ts"
      via: "week boundary computation reuse"
      pattern: "startOfWeek"
---

<objective>
Create the envelope billing module that wraps the existing debitForToolUse() function with weekly access tracking, free trial week logic, and graceful read-only degradation.

Purpose: This is the foundation for all billing enforcement. Every API route will call checkEnvelopeAccess() to determine read/write vs read-only access.
Output: billing.ts module, billing types, updated tool pricing seed.
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-billing-integration/06-RESEARCH.md

# Key source files to read before implementing:
@/Users/dweinbeck/Documents/personal-brand/src/lib/billing/firestore.ts
@/Users/dweinbeck/Documents/personal-brand/src/lib/billing/types.ts
@/Users/dweinbeck/Documents/personal-brand/src/lib/billing/tools.ts
@/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/types.ts
@/Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/week-math.ts
@/Users/dweinbeck/Documents/dave-ramsey/src/lib/envelopes/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add billing types to types.ts (both repos)</name>
  <files>
    /Users/dweinbeck/Documents/dave-ramsey/src/lib/envelopes/types.ts
    /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/types.ts
  </files>
  <action>
Add the following types to the end of types.ts in BOTH the dave-ramsey repo and the personal-brand repo:

1. **EnvelopeBilling** -- Firestore document shape for `envelope_billing/{uid}`:
```typescript
/** Tracks per-user envelope billing state in Firestore: envelope_billing/{uid}. */
export type EnvelopeBilling = {
  uid: string;
  firstAccessWeekStart: string; // YYYY-MM-DD (Sunday of first-ever access)
  paidWeeks: Record<string, {
    usageId: string;
    creditsCharged: number;
    chargedAt: Timestamp;
  }>;
  createdAt: Timestamp;
  updatedAt: Timestamp;
};
```

2. **EnvelopeAccessResult** -- discriminated union returned by checkEnvelopeAccess():
```typescript
/** Result of billing access check for envelope routes. */
export type EnvelopeAccessResult =
  | { mode: "readwrite"; weekStart: string; reason?: "free_week" }
  | { mode: "readonly"; weekStart: string; reason: "unpaid" };
```

3. **BillingStatus** -- the shape included in API GET responses for client consumption:
```typescript
/** Billing status included in envelope API GET responses. */
export type BillingStatus = {
  mode: "readwrite" | "readonly";
  reason?: "free_week" | "unpaid";
};
```

4. Update **HomePageData** to include billing:
```typescript
export type HomePageData = {
  envelopes: EnvelopeWithStatus[];
  weekLabel: string;
  cumulativeSavingsCents: number;
  billing: BillingStatus;
};
```

5. Update **TransactionsPageData** to include billing:
```typescript
export type TransactionsPageData = {
  transactions: EnvelopeTransaction[];
  billing: BillingStatus;
};
```

6. Update **AnalyticsPageData** to include billing:
Add `billing: BillingStatus;` field to the existing AnalyticsPageData type.

IMPORTANT: The dave-ramsey repo types.ts uses `import type { Timestamp } from "firebase-admin/firestore"` -- this already exists at the top. The Timestamp import is already present. Place the new types in a new section at the bottom with a clear comment block: `// Billing types (Phase 6)`.
  </action>
  <verify>
Run `cd /Users/dweinbeck/Documents/dave-ramsey && npx tsc --noEmit` to verify types compile.
Verify the personal-brand types.ts has the same new types added.
  </verify>
  <done>
EnvelopeBilling, EnvelopeAccessResult, and BillingStatus types exist in both repos. HomePageData, TransactionsPageData, and AnalyticsPageData include billing field. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create billing.ts with checkEnvelopeAccess()</name>
  <files>
    /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/billing.ts
  </files>
  <action>
Create a new file `src/lib/envelopes/billing.ts` in the personal-brand repo. This module wraps the existing `debitForToolUse()` with weekly access tracking.

Implementation details:

1. **Imports:**
   - `format, startOfWeek` from "date-fns"
   - `FieldValue` from "firebase-admin/firestore"
   - `db` from "@/lib/firebase"
   - `debitForToolUse` from "@/lib/billing/firestore"
   - `EnvelopeAccessResult, EnvelopeBilling` from "@/lib/envelopes/types"

2. **Constants:**
   - `WEEK_OPTIONS = { weekStartsOn: 0 as const }` -- reuse the same convention as week-math.ts
   - `ENVELOPE_TOOL_KEY = "dave_ramsey"` -- matches the toolKey in billing_tool_pricing

3. **envelopeBillingCol()** helper: returns `db.collection("envelope_billing")`. Throws if db not available.

4. **checkEnvelopeAccess(uid: string, email: string): Promise<EnvelopeAccessResult>** -- the main function:

   a. Compute `currentWeekStart` as `format(startOfWeek(new Date(), WEEK_OPTIONS), "yyyy-MM-dd")`

   b. Use `db.runTransaction()` to get-or-create the envelope billing doc at `envelope_billing/{uid}`:
      - If doc exists, read it as EnvelopeBilling
      - If doc does NOT exist, create it with:
        - `uid`
        - `firstAccessWeekStart: currentWeekStart`
        - `paidWeeks: {}`
        - `createdAt: FieldValue.serverTimestamp()`
        - `updatedAt: FieldValue.serverTimestamp()`
      - Return the billing doc data

   c. **Free week check:** If `billingDoc.firstAccessWeekStart === currentWeekStart`, return `{ mode: "readwrite", weekStart: currentWeekStart, reason: "free_week" }`

   d. **Already paid check:** If `billingDoc.paidWeeks?.[currentWeekStart]` exists, return `{ mode: "readwrite", weekStart: currentWeekStart }`

   e. **Attempt charge:** Call `debitForToolUse({ uid, email, toolKey: ENVELOPE_TOOL_KEY, idempotencyKey: \`envelope_week_${currentWeekStart}\` })`. The idempotency key includes uid via debitForToolUse's internal `${uid}_${idempotencyKey}` pattern.

   f. **On successful charge:** Update the billing doc with:
      ```
      docRef.update({
        [`paidWeeks.${currentWeekStart}`]: {
          usageId: debit.usageId,
          creditsCharged: debit.creditsCharged,
          chargedAt: FieldValue.serverTimestamp(),
        },
        updatedAt: FieldValue.serverTimestamp(),
      })
      ```
      Return `{ mode: "readwrite", weekStart: currentWeekStart }`

   g. **On 402 error (insufficient credits):** Catch the error, check if `error instanceof Error && "statusCode" in error && (error as Error & { statusCode: number }).statusCode === 402`. If so, return `{ mode: "readonly", weekStart: currentWeekStart, reason: "unpaid" }`.

   h. **On other errors:** Re-throw (let the calling route handle 500).

**Critical design notes:**
- The Firestore transaction for get-or-create prevents race conditions on first access
- `debitForToolUse()` already handles idempotency internally via billing_idempotency collection
- The `paidWeeks` map provides a fast lookup cache to avoid calling debitForToolUse on every request
- Week computation uses same `weekStartsOn: 0` as all envelope week math
  </action>
  <verify>
Run `cd /Users/dweinbeck/Documents/personal-brand && npx tsc --noEmit` to verify the module compiles.
Verify the file exports `checkEnvelopeAccess`.
Verify imports resolve correctly (debitForToolUse, db, types).
  </verify>
  <done>
billing.ts exists at src/lib/envelopes/billing.ts with checkEnvelopeAccess() that handles free week, paid week, charge attempt, and read-only fallback. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Activate dave_ramsey tool pricing</name>
  <files>
    /Users/dweinbeck/Documents/personal-brand/src/lib/billing/tools.ts
  </files>
  <action>
Update the `dave_ramsey` entry in `TOOL_PRICING_SEED` array in tools.ts:

Change from:
```typescript
{
  toolKey: "dave_ramsey",
  label: "Dave Ramsey App",
  active: false,
  creditsPerUse: 10,
  costToUsCentsEstimate: 5,
},
```

Change to:
```typescript
{
  toolKey: "dave_ramsey",
  label: "Digital Envelopes",
  active: true,
  creditsPerUse: 100,
  costToUsCentsEstimate: 0,
},
```

Changes:
- `label`: "Dave Ramsey App" -> "Digital Envelopes" (matches the actual product name)
- `active`: false -> true (enables the tool for billing)
- `creditsPerUse`: 10 -> 100 (matches the requirement: 100 credits per week)
- `costToUsCentsEstimate`: 5 -> 0 (no incremental cost to platform for envelope access)

NOTE: This updates the seed for new deployments. For production, the existing Firestore document also needs updating. Since `seedToolPricing()` only creates docs that don't exist (it skips existing ones), the production document must be updated separately. Add a comment above the entry noting this:
```typescript
// NOTE: If already seeded in production, update via PUT /api/admin/billing/pricing
```
  </action>
  <verify>
Run `cd /Users/dweinbeck/Documents/personal-brand && npx tsc --noEmit` to verify tools.ts still compiles.
Verify the dave_ramsey entry has active: true, creditsPerUse: 100, costToUsCentsEstimate: 0.
  </verify>
  <done>
dave_ramsey tool pricing seed updated to active: true, creditsPerUse: 100, costToUsCentsEstimate: 0, label: "Digital Envelopes".
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/dweinbeck/Documents/dave-ramsey && npx tsc --noEmit` passes
2. `cd /Users/dweinbeck/Documents/personal-brand && npx tsc --noEmit` passes
3. `grep -n "checkEnvelopeAccess" /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/billing.ts` shows the exported function
4. `grep -n "EnvelopeAccessResult\|EnvelopeBilling\|BillingStatus" /Users/dweinbeck/Documents/personal-brand/src/lib/envelopes/types.ts` shows all three types
5. `grep -n "active: true" /Users/dweinbeck/Documents/personal-brand/src/lib/billing/tools.ts` includes dave_ramsey
</verification>

<success_criteria>
- checkEnvelopeAccess() function exists and handles: free week, already-paid week, charge attempt, 402 fallback to readonly
- EnvelopeBilling, EnvelopeAccessResult, and BillingStatus types defined in both repos
- HomePageData, TransactionsPageData, AnalyticsPageData include billing: BillingStatus field
- dave_ramsey tool pricing is active with 100 credits
- TypeScript compiles in both repos
</success_criteria>

<output>
After completion, create `.planning/phases/06-billing-integration/06-01-SUMMARY.md`
</output>
