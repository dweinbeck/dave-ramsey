---
phase: 05-analytics
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/envelopes/types.ts
  - src/lib/envelopes/firestore.ts
  - src/lib/envelopes/__tests__/firestore.test.ts

autonomous: true

must_haves:
  truths:
    - "computeWeeklySavingsBreakdown returns per-week savings with running cumulative total for all completed weeks"
    - "buildPivotRows groups transactions by week and envelope, returning newest-first rows with per-envelope cell totals"
    - "Analytics response types (AnalyticsPageData, PivotRow, WeeklySavingsEntry) are exported and correctly structured"
  artifacts:
    - path: "src/lib/envelopes/types.ts"
      provides: "AnalyticsPageData, PivotRow, WeeklySavingsEntry types"
      contains: "AnalyticsPageData"
    - path: "src/lib/envelopes/firestore.ts"
      provides: "computeWeeklySavingsBreakdown, buildPivotRows pure functions"
      exports: ["computeWeeklySavingsBreakdown", "buildPivotRows"]
    - path: "src/lib/envelopes/__tests__/firestore.test.ts"
      provides: "Tests for both new pure computation helpers"
      contains: "computeWeeklySavingsBreakdown"
  key_links:
    - from: "src/lib/envelopes/firestore.ts"
      to: "computeSavingsForWeek"
      via: "computeWeeklySavingsBreakdown delegates per-week savings to existing helper"
      pattern: "computeSavingsForWeek"
    - from: "src/lib/envelopes/firestore.ts"
      to: "src/lib/envelopes/week-math.ts"
      via: "getWeekNumber import for week labels"
      pattern: "getWeekNumber"
---

<objective>
Add pure computation helpers for analytics data aggregation and the TypeScript types for the analytics API response.

Purpose: These pure functions and types form the foundation for the analytics API endpoint and UI. By building and testing them in the dave-ramsey repo first (TDD), we ensure consistent computation logic that can be copied to the personal-brand repo.

Output: Two new exported pure functions (`computeWeeklySavingsBreakdown`, `buildPivotRows`) with comprehensive test coverage, plus three new TypeScript types (`AnalyticsPageData`, `PivotRow`, `WeeklySavingsEntry`).
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/envelopes/types.ts
@src/lib/envelopes/firestore.ts
@src/lib/envelopes/week-math.ts
@src/lib/envelopes/__tests__/firestore.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add analytics response types to types.ts</name>
  <files>src/lib/envelopes/types.ts</files>
  <action>
Add three new types at the bottom of types.ts under a new "Analytics types" comment section:

```typescript
// ---------------------------------------------------------------------------
// Analytics types (used by GET /api/envelopes/analytics)
// ---------------------------------------------------------------------------

/** Single row in the weekly savings breakdown (for savings chart). */
export type WeeklySavingsEntry = {
  weekStart: string;        // "2026-01-05" (YYYY-MM-DD)
  weekLabel: string;        // "Wk 2"
  savingsCents: number;     // savings for this single week
  cumulativeCents: number;  // running total through this week
};

/** Single row in the weekly pivot table. */
export type PivotRow = {
  weekStart: string;                  // "2026-01-05" (YYYY-MM-DD)
  weekLabel: string;                  // "Wk 2"
  cells: Record<string, number>;      // envelopeId -> sum of transaction amountCents
  totalCents: number;                 // sum across all envelopes for this week
};

/** Response shape for GET /api/envelopes/analytics. */
export type AnalyticsPageData = {
  summary: {
    totalSpentCents: number;
    totalBudgetCents: number;
    totalRemainingCents: number;
    onTrackCount: number;
    totalEnvelopeCount: number;
  };
  envelopes: { id: string; title: string }[];  // column headers for pivot table
  pivotRows: PivotRow[];                        // rows, newest week first
  savingsByWeek: WeeklySavingsEntry[];           // oldest first (for chart x-axis)
};
```

Do NOT change any existing types. Only append.
  </action>
  <verify>Run `npx tsc --noEmit` from the dave-ramsey repo root. No type errors.</verify>
  <done>AnalyticsPageData, PivotRow, and WeeklySavingsEntry types are exported from types.ts and pass type checking.</done>
</task>

<feature>
  <name>Task 2: computeWeeklySavingsBreakdown and buildPivotRows (TDD)</name>
  <files>src/lib/envelopes/firestore.ts, src/lib/envelopes/__tests__/firestore.test.ts</files>
  <behavior>
**computeWeeklySavingsBreakdown(envelopes, transactions, earliestWeekStart, currentWeekStart) -> WeeklySavingsEntry[]**

Iterates completed weeks from earliestWeekStart to currentWeekStart (exclusive). For each week:
1. Compute week end date (Saturday) from week start (Sunday) using addWeeks - 1 day
2. Filter transactions to that week's date range
3. Delegate to existing `computeSavingsForWeek` for per-week savings
4. Track running cumulative total
5. Generate week label using `getWeekNumber` -> "Wk N"

Returns array ordered oldest-first (chronological, for chart rendering).

Test cases:
- Empty envelopes array -> returns []
- Single week with no transactions -> returns one entry with full budget as savings (non-rollover envelopes only)
- Multiple weeks with mixed spending -> correct per-week and cumulative totals
- Rollover envelopes excluded from savings (delegates to computeSavingsForWeek which handles this)
- Envelope created mid-range -> only counted from creation week onward (delegates to computeSavingsForWeek)

**buildPivotRows(transactions, earliestWeekStart, currentWeekEnd) -> PivotRow[]**

Groups all transactions by week (Sunday-Saturday), then by envelopeId within each week. Iterates from earliestWeekStart through currentWeekEnd. For each week:
1. Filter transactions to that week's date range
2. Build cells Record: envelopeId -> sum of amountCents
3. Compute totalCents as sum across all envelopes
4. Generate weekLabel using getWeekNumber -> "Wk N"

Returns array ordered newest-first (most recent week at top of table).
Omit weeks with zero transactions (skip empty rows).

Test cases:
- No transactions -> returns []
- Single transaction in one week -> one row, one cell, totalCents = amountCents
- Transactions across 3 weeks and 2 envelopes -> 3 rows (newest first), cells per envelope, correct totals
- Multiple transactions same week same envelope -> amounts summed in cell
- Week with no transactions is omitted from results
  </behavior>
  <implementation>
Add both functions to firestore.ts in the "Pure computation helpers" section (after computeCumulativeSavingsFromData).

Import `getWeekNumber` from `./week-math` (add to existing import statement).
Import `WeeklySavingsEntry` and `PivotRow` from `./types` (add to existing import).

**computeWeeklySavingsBreakdown** reuses the exact same week iteration pattern as `computeCumulativeSavingsFromData` but accumulates per-week entries instead of just a running total. This is intentional -- same logic, different output shape.

**buildPivotRows** uses the same week iteration pattern but groups transactions differently (by envelopeId within each week) and only includes weeks with transactions.

Both functions use `addWeeks` from date-fns (already imported) and `format` (already imported).

Add tests to the existing `firestore.test.ts` file, in a new `describe("computeWeeklySavingsBreakdown")` and `describe("buildPivotRows")` block.
  </implementation>
</feature>

</tasks>

<verification>
1. `npm test` passes in dave-ramsey repo (all existing + new tests green)
2. `npx tsc --noEmit` passes (no type errors)
3. New functions are exported: `grep "export function computeWeeklySavingsBreakdown" src/lib/envelopes/firestore.ts`
4. New functions are exported: `grep "export function buildPivotRows" src/lib/envelopes/firestore.ts`
5. New types are exported: `grep "export type AnalyticsPageData" src/lib/envelopes/types.ts`
</verification>

<success_criteria>
- computeWeeklySavingsBreakdown passes all test cases, returns chronological WeeklySavingsEntry[] with correct per-week and cumulative savings
- buildPivotRows passes all test cases, returns newest-first PivotRow[] with correct per-envelope transaction sums
- AnalyticsPageData, PivotRow, WeeklySavingsEntry types exported from types.ts
- All existing tests still pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-analytics/05-01-SUMMARY.md`
</output>
