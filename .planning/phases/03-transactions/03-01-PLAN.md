---
phase: 03-transactions
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/lib/envelopes/week-math.ts
  - src/lib/envelopes/__tests__/week-math.test.ts
  - src/lib/envelopes/types.ts
  - src/lib/envelopes/__tests__/types.test.ts
autonomous: true

must_haves:
  truths:
    - "getWeekNumber returns correct US-convention week-of-year number for any date"
    - "transactionUpdateSchema validates partial transaction updates with all fields optional"
    - "TransactionsPageData type shapes the transaction list API response"
  artifacts:
    - path: "src/lib/envelopes/week-math.ts"
      provides: "getWeekNumber utility wrapping date-fns getWeek"
      exports: ["getWeekNumber"]
    - path: "src/lib/envelopes/types.ts"
      provides: "transactionUpdateSchema, TransactionUpdateInput, TransactionsPageData"
      exports: ["transactionUpdateSchema", "TransactionUpdateInput", "TransactionsPageData"]
  key_links:
    - from: "src/lib/envelopes/week-math.ts"
      to: "date-fns/getWeek"
      via: "import"
      pattern: "getWeek.*weekStartsOn.*0"
---

<objective>
Add getWeekNumber utility for week selector display and transaction update types for edit functionality, using TDD in the dave-ramsey repo.

Purpose: The week selector on the Transactions page needs a week-of-year number ("Week N: ..."), and transaction editing needs a partial update schema. Both have clear input/output contracts ideal for TDD.
Output: Tested getWeekNumber function + transactionUpdateSchema + TransactionsPageData type
</objective>

<execution_context>
@/Users/dweinbeck/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dweinbeck/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-transactions/03-RESEARCH.md

Key existing code:
- src/lib/envelopes/week-math.ts -- existing week utilities (getWeekRange, formatWeekLabel, etc.)
- src/lib/envelopes/__tests__/week-math.test.ts -- existing tests to extend
- src/lib/envelopes/types.ts -- existing Zod schemas and types to extend

Decisions:
- date-fns getWeek with { weekStartsOn: 0, firstWeekContainsDate: 1 } for US convention
- "zod/v4" import path (repo convention)
- TransactionsPageData = { transactions: EnvelopeTransaction[] }
</context>

<feature>
  <name>getWeekNumber</name>
  <files>src/lib/envelopes/week-math.ts, src/lib/envelopes/__tests__/week-math.test.ts</files>
  <behavior>
    Returns the week-of-year number for a given date using US conventions (Sunday start, first week contains Jan 1).

    Cases:
    - Sunday Feb 8, 2026 -> week 7 (7th week of the year, Sunday start)
    - Wednesday Feb 11, 2026 -> week 7 (same week)
    - Sunday Jan 4, 2026 -> week 2 (first full week after Jan 1)
    - Thursday Jan 1, 2026 -> week 1 (first week contains Jan 1)
    - Wednesday Dec 31, 2025 -> week 1 of 2026 (or 53 of 2025 depending on getWeek behavior -- verify against date-fns)

    Note: Use `getWeek(date, { weekStartsOn: 0, firstWeekContainsDate: 1 })` from date-fns.
    The firstWeekContainsDate: 1 means "the first week of the year is the one containing January 1st."
  </behavior>
  <implementation>
    Import getWeek from date-fns. Create a simple wrapper that passes the US convention options.
    Export from week-math.ts alongside existing functions.
  </implementation>
</feature>

<tasks>

<task type="auto">
  <name>Task 1: TDD getWeekNumber + transaction types</name>
  <files>
    src/lib/envelopes/__tests__/week-math.test.ts
    src/lib/envelopes/week-math.ts
    src/lib/envelopes/types.ts
    src/lib/envelopes/__tests__/types.test.ts
  </files>
  <action>
    **RED phase -- Write failing tests:**

    1. In `src/lib/envelopes/__tests__/week-math.test.ts`, add a new `describe("getWeekNumber", ...)` block with these test cases:
       - `it("returns week 7 for Sunday Feb 8, 2026")` -> `expect(getWeekNumber(new Date(2026, 1, 8))).toBe(7)`
       - `it("returns week 7 for Wednesday Feb 11, 2026")` -> `expect(getWeekNumber(new Date(2026, 1, 11))).toBe(7)`
       - `it("returns week 1 for Thursday Jan 1, 2026")` -> `expect(getWeekNumber(new Date(2026, 0, 1))).toBe(1)`
       - `it("returns week 2 for Sunday Jan 4, 2026")` -> `expect(getWeekNumber(new Date(2026, 0, 4))).toBe(2)`
       - `it("handles year boundary -- Dec 31, 2025")` -> test that getWeekNumber returns a valid number (verify the actual expected value by checking what `getWeek(new Date(2025, 11, 31), { weekStartsOn: 0, firstWeekContainsDate: 1 })` returns, and assert against that)

    2. Import `getWeekNumber` from `../week-math` in the test file.

    3. Run `npm test` -- tests MUST fail (function doesn't exist yet).

    **GREEN phase -- Implement:**

    4. In `src/lib/envelopes/week-math.ts`:
       - Add `import { getWeek } from "date-fns"` to the existing imports (alongside differenceInCalendarDays, endOfWeek, format, startOfWeek).
       - Add the function:
         ```typescript
         /**
          * Returns the week-of-year number for a given date, using US conventions:
          * - Weeks start on Sunday (weekStartsOn: 0)
          * - First week of the year contains January 1st (firstWeekContainsDate: 1)
          */
         export function getWeekNumber(date: Date): number {
           return getWeek(date, { weekStartsOn: 0, firstWeekContainsDate: 1 });
         }
         ```

    5. Run `npm test` -- all tests MUST pass.

    **Transaction types (standard, not TDD -- no complex logic):**

    6. In `src/lib/envelopes/types.ts`, add after the `transactionSchema`:
       ```typescript
       /** Transaction partial update payload (all fields optional). */
       export const transactionUpdateSchema = z.object({
         envelopeId: z.string().min(1).optional(),
         amountCents: z.number().int().min(1).optional(),
         date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, "Date must be YYYY-MM-DD").optional(),
         merchant: z.string().max(200).optional(),
         description: z.string().max(500).optional(),
       });
       export type TransactionUpdateInput = z.infer<typeof transactionUpdateSchema>;
       ```

    7. At the bottom of `src/lib/envelopes/types.ts`, add:
       ```typescript
       /** Response shape for GET /api/envelopes/transactions?weekStart=...&weekEnd=... */
       export type TransactionsPageData = {
         transactions: EnvelopeTransaction[];
       };
       ```

    8. In `src/lib/envelopes/__tests__/types.test.ts`, add tests for `transactionUpdateSchema`:
       - Valid: `{ amountCents: 500 }` (single field) -> success
       - Valid: `{ envelopeId: "abc", amountCents: 1500, date: "2026-02-10" }` (multiple fields) -> success
       - Valid: `{}` (empty object, all optional) -> success
       - Invalid: `{ amountCents: 0 }` -> fail (min 1)
       - Invalid: `{ date: "02-10-2026" }` -> fail (wrong format)
       - Invalid: `{ amountCents: 12.5 }` -> fail (not integer)

    9. Run `npm test` -- ALL tests must pass.
  </action>
  <verify>
    ```bash
    cd /Users/dweinbeck/Documents/dave-ramsey && npm test
    ```
    All tests pass including new getWeekNumber and transactionUpdateSchema tests.
  </verify>
  <done>
    - getWeekNumber(date) returns correct US-convention week number for all test cases
    - transactionUpdateSchema validates partial updates correctly (all fields optional, same constraints as transactionSchema per-field)
    - TransactionsPageData type exported
    - All existing tests still pass (no regressions)
  </done>
</task>

</tasks>

<verification>
```bash
cd /Users/dweinbeck/Documents/dave-ramsey && npm test
```
- All week-math tests pass (existing + new getWeekNumber tests)
- All types tests pass (existing + new transactionUpdateSchema tests)
- No regressions in any other test files
</verification>

<success_criteria>
- getWeekNumber is exported from week-math.ts and returns correct week numbers
- transactionUpdateSchema is exported from types.ts with all fields optional
- TransactionUpdateInput type is exported
- TransactionsPageData type is exported
- All tests pass with zero failures
</success_criteria>

<output>
After completion, create `.planning/phases/03-transactions/03-01-SUMMARY.md`
</output>
